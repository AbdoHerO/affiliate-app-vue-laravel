import{d as ge,r as g,V as G,g as A,o as v,f as a,b as e,e as n,az as x,t as d,ac as k,c as y,l as w,aV as $e,s as p,F as J,i as fe,aL as ze,m as _,j as Qe,D as Xe,p as Ze}from"./main-uLG9IIeX.js";import{u as et}from"./shipping-CrLFy0ND.js";import{useConfirmAction as tt}from"./useConfirmAction-C-KKQTYr.js";import{u as at}from"./useNotifications-DDBS_wPD.js";import{V as j,b as ye,c as be}from"./VCard-CB1gT6RB.js";import{V as X}from"./VSpacer-BCNmCEP9.js";import{V as ie}from"./VDivider-UqGR4x4D.js";import{V as q}from"./VCardText-BZtszuIK.js";import{a as st,V as Te,b as lt,c as Se}from"./VTabs-BkhoRyPL.js";import{V as De,a as U}from"./VRow-aGfXYx3U.js";import{V as P}from"./VChip-B84WcmDa.js";import{V as it,a as nt}from"./VTimeline-BKtdccnZ.js";import{V as he}from"./VDialog-DU1pBIct.js";import{V as te,a as ae}from"./VAlert-TgguXW_5.js";import{O as rt}from"./OzonExpressConfirmDialog-4wkpIU85.js";import{V as me}from"./VTextField-Dxeq5kx5.js";import{V as ve}from"./VSelect-sWnAtot-.js";import{V as ot}from"./VDataTableServer-DfLBg0lg.js";import{V as Q}from"./VTooltip-Ce3bfmSx.js";import{V as dt}from"./VMenu-DP1p-55V.js";import{V as ut,a as se,b as le}from"./VList-uZDByhc2.js";import{V as ct}from"./VTextarea-BuIc6d95.js";import"./createSimpleFunctional-DugzUcbB.js";import"./VAvatar-bHPDEsYY.js";import"./VImg-BS6_svHJ.js";/* empty css              */import"./forwardRefs-Dv_T9a_w.js";import"./lazy-CjF3Yiep.js";import"./VWindowItem-DPvP18Ki.js";import"./ssrBoot-BPhRU-mF.js";import"./dialog-transition-2hF0ajsQ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./VField-CfH1YcVv.js";import"./VCheckboxBtn-CogF2AUK.js";import"./VDataTable-DNqSzzrc.js";import"./VPagination-DYW6O4lq.js";import"./VTable-0U-NvIH3.js";import"./filter-D_SbaZWa.js";const pt={class:"text-body-2 text-medium-emphasis mb-0"},_t={key:0,class:"text-center py-8"},mt={key:1,class:"text-center py-8"},vt={class:"text-body-2 text-medium-emphasis"},ft={key:2},gt={class:"d-flex flex-column gap-3"},yt={class:"d-flex justify-space-between"},bt={class:"d-flex justify-space-between"},ht={key:0,class:"d-flex justify-space-between"},kt={class:"text-body-2"},xt={key:1,class:"d-flex justify-space-between"},Vt={key:2,class:"d-flex justify-space-between"},Ct={class:"text-body-2"},wt={class:"d-flex flex-column gap-3"},Tt={key:0,class:"d-flex justify-space-between"},St={class:"text-body-2 font-weight-bold"},$t={key:1,class:"d-flex justify-space-between"},zt={class:"text-body-2"},Dt={key:2,class:"d-flex justify-space-between"},It={class:"text-body-2 text-medium-emphasis"},Nt={class:"text-body-2"},Rt={key:3,class:"d-flex justify-space-between"},At={class:"text-body-2"},Et={key:0},Ot={class:"d-flex justify-space-between align-center mb-2"},Pt={class:"text-caption text-medium-emphasis"},Ft={key:0,class:"text-body-2 mb-0"},Lt={key:1,class:"text-center py-8"},Ut=ge({__name:"TrackingModal",props:{modelValue:{type:Boolean},trackingNumber:{},trackingData:{},loading:{type:Boolean,default:!1},error:{default:""}},emits:["update:modelValue","refresh","retry"],setup(Z,{emit:t}){const T=Z,V=t,F=g("summary"),b=u=>{V("update:modelValue",u)},h=G(()=>{var i,c,l,m,E,I;if((c=(i=T.trackingData)==null?void 0:i.parcel)!=null&&c.status)return{status:T.trackingData.parcel.status,status_text:T.trackingData.parcel.last_status_text||T.trackingData.parcel.status,time:T.trackingData.parcel.last_status_at,comment:(l=T.trackingData.parcel.meta)==null?void 0:l.last_status_comment};if(!((I=(E=(m=T.trackingData)==null?void 0:m.tracking_info)==null?void 0:E.TRACKING)!=null&&I.LAST_TRACKING))return null;const u=T.trackingData.tracking_info.TRACKING.LAST_TRACKING;return{status:S(u.STATUT),status_text:u.STATUT,time:u.TIME_STR,comment:u.COMMENT}}),f=G(()=>{var i,c,l;if(!((l=(c=(i=T.trackingData)==null?void 0:i.parcel_info)==null?void 0:c.PARCEL_INFO)!=null&&l.INFOS))return null;const u=T.trackingData.parcel_info.PARCEL_INFO.INFOS;return{city_name:u.CITY_NAME,receiver:u.RECEIVER,price:parseFloat(u.PRICE)||0,delivered_price:parseFloat(u["DELIVERED-PRICE"])||0,returned_price:parseFloat(u["RETURNED-PRICE"])||0,refused_price:parseFloat(u["REFUSED-PRICE"])||0}}),$=G(()=>{var i,c,l;if(!((l=(c=(i=T.trackingData)==null?void 0:i.tracking_info)==null?void 0:c.TRACKING)!=null&&l.HISTORY))return[];const u=T.trackingData.tracking_info.TRACKING.HISTORY;return Array.isArray(u)?u.map(m=>({status:S(m.STATUT),status_text:m.STATUT,time:m.TIME_STR,comment:m.COMMENT})).reverse():[]}),S=u=>u&&{"Nouveau Colis":"pending","Colis Reçu":"received","En Transit":"in_transit","En Cours de Livraison":"out_for_delivery",Livré:"delivered",Retourné:"returned",Refusé:"refused",Annulé:"cancelled","En Attente":"pending",Expédié:"shipped","Arrivé au Centre":"at_facility","Prêt pour Livraison":"ready_for_delivery","Tentative de Livraison":"delivery_attempted"}[u]||"unknown",z=u=>{switch(u==null?void 0:u.toLowerCase()){case"delivered":return"success";case"in_transit":case"out_for_delivery":case"shipped":return"info";case"pending":case"received":case"at_facility":case"ready_for_delivery":return"warning";case"cancelled":case"refused":case"delivery_attempted":return"error";case"returned":return"secondary";default:return"default"}},N=u=>{switch(u==null?void 0:u.toLowerCase()){case"delivered":return"tabler-check";case"in_transit":return"tabler-truck";case"out_for_delivery":return"tabler-truck-delivery";case"shipped":return"tabler-truck";case"pending":return"tabler-package";case"received":return"tabler-package-import";case"at_facility":return"tabler-building-warehouse";case"ready_for_delivery":return"tabler-truck-loading";case"returned":return"tabler-package-export";case"refused":return"tabler-x";case"cancelled":return"tabler-ban";case"delivery_attempted":return"tabler-clock-exclamation";default:return"tabler-circle"}},C=u=>new Intl.NumberFormat("fr-MA",{style:"currency",currency:"MAD"}).format(u),L=u=>{try{return new Date(u).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return u}};return(u,i)=>(v(),A(he,{"model-value":u.modelValue,"max-width":"800",persistent:"","onUpdate:modelValue":b},{default:a(()=>[e(j,null,{default:a(()=>[e(ye,{class:"d-flex align-center gap-2 pa-6"},{default:a(()=>[e(x,{icon:"tabler-route",color:"primary"}),n("div",null,[i[6]||(i[6]=n("h6",{class:"text-h6"},"Suivi de Colis",-1)),n("p",pt,d(u.trackingNumber),1)]),e(X),e(k,{icon:"tabler-x",variant:"text",size:"small",onClick:i[0]||(i[0]=c=>b(!1))})]),_:1}),e(ie),e(q,{class:"pa-0"},{default:a(()=>[u.loading?(v(),y("div",_t,[e($e,{indeterminate:"",color:"primary"}),i[7]||(i[7]=n("p",{class:"mt-4 text-body-1"},"Chargement du suivi...",-1))])):u.error?(v(),y("div",mt,[e(x,{icon:"tabler-alert-circle",size:"64",color:"error",class:"mb-4"}),i[9]||(i[9]=n("h6",{class:"text-h6 mb-2"},"Erreur de suivi",-1)),n("p",vt,d(u.error),1),e(k,{color:"primary",variant:"outlined",onClick:i[1]||(i[1]=c=>u.$emit("retry"))},{default:a(()=>i[8]||(i[8]=[p(" Réessayer ")])),_:1,__:[8]})])):u.trackingData?(v(),y("div",ft,[e(st,{modelValue:F.value,"onUpdate:modelValue":i[2]||(i[2]=c=>F.value=c),class:"border-b"},{default:a(()=>[e(Te,{value:"summary"},{default:a(()=>[e(x,{start:"",icon:"tabler-info-circle"}),i[10]||(i[10]=p(" Résumé "))]),_:1,__:[10]}),e(Te,{value:"history"},{default:a(()=>[e(x,{start:"",icon:"tabler-history"}),i[11]||(i[11]=p(" Historique "))]),_:1,__:[11]})]),_:1},8,["modelValue"]),e(lt,{modelValue:F.value,"onUpdate:modelValue":i[3]||(i[3]=c=>F.value=c)},{default:a(()=>[e(Se,{value:"summary",class:"pa-6"},{default:a(()=>[e(De,null,{default:a(()=>[e(U,{cols:"12",md:"6"},{default:a(()=>[e(j,{variant:"outlined",class:"h-100"},{default:a(()=>[e(q,null,{default:a(()=>{var c,l,m,E;return[i[17]||(i[17]=n("h6",{class:"text-h6 mb-4"},"Informations du Colis",-1)),n("div",gt,[n("div",yt,[i[12]||(i[12]=n("span",{class:"text-body-2 text-medium-emphasis"},"Numéro de suivi:",-1)),e(P,{size:"small",color:"primary",variant:"tonal",class:"font-mono"},{default:a(()=>[p(d(u.trackingNumber),1)]),_:1})]),n("div",bt,[i[13]||(i[13]=n("span",{class:"text-body-2 text-medium-emphasis"},"Statut actuel:",-1)),e(P,{size:"small",color:z((c=h.value)==null?void 0:c.status),variant:"tonal"},{default:a(()=>{var I;return[p(d(((I=h.value)==null?void 0:I.status_text)||"Inconnu"),1)]}),_:1},8,["color"])]),(l=h.value)!=null&&l.time?(v(),y("div",ht,[i[14]||(i[14]=n("span",{class:"text-body-2 text-medium-emphasis"},"Dernière mise à jour:",-1)),n("span",kt,d(L(h.value.time)),1)])):w("",!0),(m=f.value)!=null&&m.city_name?(v(),y("div",xt,[i[15]||(i[15]=n("span",{class:"text-body-2 text-medium-emphasis"},"Ville:",-1)),e(P,{size:"small",color:"info",variant:"tonal"},{default:a(()=>[p(d(f.value.city_name),1)]),_:1})])):w("",!0),(E=f.value)!=null&&E.receiver?(v(),y("div",Vt,[i[16]||(i[16]=n("span",{class:"text-body-2 text-medium-emphasis"},"Destinataire:",-1)),n("span",Ct,d(f.value.receiver),1)])):w("",!0)])]}),_:1,__:[17]})]),_:1})]),_:1}),e(U,{cols:"12",md:"6"},{default:a(()=>[e(j,{variant:"outlined",class:"h-100"},{default:a(()=>[e(q,null,{default:a(()=>{var c,l,m,E;return[i[21]||(i[21]=n("h6",{class:"text-h6 mb-4"},"Tarification",-1)),n("div",wt,[(c=f.value)!=null&&c.price?(v(),y("div",Tt,[i[18]||(i[18]=n("span",{class:"text-body-2 text-medium-emphasis"},"Prix du colis:",-1)),n("span",St,d(C(f.value.price)),1)])):w("",!0),(l=f.value)!=null&&l.delivered_price?(v(),y("div",$t,[i[19]||(i[19]=n("span",{class:"text-body-2 text-medium-emphasis"},"Frais de livraison:",-1)),n("span",zt,d(C(f.value.delivered_price)),1)])):w("",!0),(m=f.value)!=null&&m.returned_price?(v(),y("div",Dt,[n("span",It,d(u.t("labels.returnFee"))+":",1),n("span",Nt,d(C(f.value.returned_price)),1)])):w("",!0),(E=f.value)!=null&&E.refused_price?(v(),y("div",Rt,[i[20]||(i[20]=n("span",{class:"text-body-2 text-medium-emphasis"},"Frais de refus:",-1)),n("span",At,d(C(f.value.refused_price)),1)])):w("",!0)])]}),_:1,__:[21]})]),_:1})]),_:1})]),_:1})]),_:1}),e(Se,{value:"history",class:"pa-6"},{default:a(()=>[$.value&&$.value.length>0?(v(),y("div",Et,[e(it,{side:"end",class:"pt-0"},{default:a(()=>[(v(!0),y(J,null,fe($.value,(c,l)=>(v(),A(nt,{key:l,"dot-color":z(c.status),size:"small"},{icon:a(()=>[e(x,{icon:N(c.status),size:"16"},null,8,["icon"])]),default:a(()=>[e(j,{variant:"outlined",class:"mb-2"},{default:a(()=>[e(q,{class:"pa-4"},{default:a(()=>[n("div",Ot,[e(P,{size:"small",color:z(c.status),variant:"tonal"},{default:a(()=>[p(d(c.status_text),1)]),_:2},1032,["color"]),n("span",Pt,d(L(c.time)),1)]),c.comment?(v(),y("p",Ft,d(c.comment),1)):w("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1032,["dot-color"]))),128))]),_:1})])):(v(),y("div",Lt,[e(x,{icon:"tabler-history-off",size:"64",color:"disabled",class:"mb-4"}),i[22]||(i[22]=n("h6",{class:"text-h6 mb-2"},"Aucun historique",-1)),i[23]||(i[23]=n("p",{class:"text-body-2 text-medium-emphasis"}," Aucun événement de suivi disponible pour ce colis ",-1))]))]),_:1})]),_:1},8,["modelValue"])])):w("",!0)]),_:1}),e(ie),e(be,{class:"pa-6"},{default:a(()=>[e(k,{color:"primary",variant:"outlined",onClick:i[4]||(i[4]=c=>u.$emit("refresh")),loading:u.loading},{default:a(()=>[e(x,{start:"",icon:"tabler-refresh"}),i[24]||(i[24]=p(" Actualiser "))]),_:1,__:[24]},8,["loading"]),e(X),e(k,{color:"secondary",variant:"text",onClick:i[5]||(i[5]=c=>b(!1))},{default:a(()=>[p(d(u.t("actions.close")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),jt={key:0},Mt={class:"text-center mb-6"},Bt={key:1},qt={class:"mb-4"},Gt={class:"text-body-2 text-medium-emphasis"},Kt={class:"mb-2"},Ht={class:"d-flex flex-wrap gap-1"},Yt={key:2},Jt={class:"text-center mb-6"},Wt={class:"text-body-2 text-medium-emphasis"},Qt={class:"d-flex flex-column gap-3"},Xt={key:3,class:"text-center py-8"},Zt={class:"mt-4 text-body-1"},ea={key:4,class:"text-center py-4"},ta={class:"mb-0"},aa=ge({__name:"DeliveryNoteDialog",props:{modelValue:{type:Boolean},selectedTrackingNumbers:{}},emits:["update:modelValue","created"],setup(Z,{emit:t}){const{t:T}=ze(),V=Z,F=t,b=g(1),h=g(!1),f=g(""),$=g(""),S=g(""),z=g({}),N=c=>{c||(b.value=1,f.value="",S.value="",z.value={}),F("update:modelValue",c)},C=G(()=>[{key:"bl_pdf",label:"Bon de Livraison PDF",icon:"tabler-file-type-pdf",color:"error",url:z.value.bl_pdf},{key:"tickets_a4",label:"Étiquettes A4",icon:"tabler-printer",color:"info",url:z.value.tickets_a4},{key:"tickets_100x100",label:"Étiquettes 100×100",icon:"tabler-qrcode",color:"success",url:z.value.tickets_100x100}]),L=async()=>{var c;h.value=!0,$.value="Création du bon de livraison...",f.value="";try{const m=await(await fetch("/api/admin/shipping/ozon/dn/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}})).json();m.success?(S.value=m.data.ref,b.value=2):f.value=m.message||"Erreur lors de la création du bon de livraison"}catch(l){((c=l.response)==null?void 0:c.status)===404?f.value="Fonctionnalité de bon de livraison non disponible dans cette version d'OzonExpress":f.value="Erreur de connexion: "+l.message}finally{h.value=!1}},u=async()=>{var c;h.value=!0,$.value="Ajout des colis...",f.value="";try{const m=await(await fetch("/api/admin/shipping/ozon/dn/add-parcels",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({ref:S.value,codes:V.selectedTrackingNumbers})})).json();if(!m.success){f.value=m.message||"Erreur lors de l'ajout des colis";return}$.value="Sauvegarde du bon de livraison...";const I=await(await fetch("/api/admin/shipping/ozon/dn/save",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({ref:S.value})})).json();if(!I.success){f.value=I.message||"Erreur lors de la sauvegarde";return}$.value="Génération des liens PDF...";const ee=await(await fetch(`/api/admin/shipping/ozon/dn/pdf?ref=${S.value}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}})).json();ee.success&&(z.value=ee.data.pdf_links),b.value=3,F("created",S.value)}catch(l){((c=l.response)==null?void 0:c.status)===404?f.value="Fonctionnalité de bon de livraison non disponible dans cette version d'OzonExpress":f.value="Erreur de connexion: "+l.message}finally{h.value=!1}},i=()=>{b.value>1&&(b.value--,f.value="")};return(c,l)=>(v(),A(he,{"model-value":c.modelValue,"max-width":"600",persistent:"","onUpdate:modelValue":N},{default:a(()=>[e(j,null,{default:a(()=>[e(ye,{class:"d-flex align-center gap-2 pa-6"},{default:a(()=>[e(x,{icon:"tabler-file-plus",color:"primary"}),l[2]||(l[2]=n("div",null,[n("h6",{class:"text-h6"},"Bon de Livraison"),n("p",{class:"text-body-2 text-medium-emphasis mb-0"}," Créer et gérer les bons de livraison OzonExpress ")],-1)),e(X),e(k,{icon:"tabler-x",variant:"text",size:"small",onClick:l[0]||(l[0]=m=>N(!1))})]),_:1,__:[2]}),e(ie),e(q,{class:"pa-6"},{default:a(()=>[b.value===1?(v(),y("div",jt,[n("div",Mt,[e(x,{icon:"tabler-file-plus",size:"64",color:"primary",class:"mb-4"}),l[3]||(l[3]=n("h6",{class:"text-h6 mb-2"},"Créer un nouveau bon de livraison",-1)),l[4]||(l[4]=n("p",{class:"text-body-2 text-medium-emphasis"}," Un bon de livraison vous permet de regrouper plusieurs colis pour l'impression d'étiquettes ",-1))]),e(te,{type:"info",variant:"tonal",class:"mb-4"},{default:a(()=>[e(ae,null,{default:a(()=>l[5]||(l[5]=[p("Information")])),_:1,__:[5]}),l[6]||(l[6]=n("p",{class:"mb-0"}," Après création, vous pourrez ajouter les colis sélectionnés au bon de livraison. ",-1))]),_:1,__:[6]})])):b.value===2?(v(),y("div",Bt,[n("div",qt,[l[8]||(l[8]=n("h6",{class:"text-h6 mb-2"},"Ajouter des colis",-1)),n("p",Gt,[l[7]||(l[7]=p(" Référence du bon: ")),e(P,{size:"small",color:"primary",variant:"tonal"},{default:a(()=>[p(d(S.value),1)]),_:1})])]),e(te,{type:"success",variant:"tonal",class:"mb-4"},{default:a(()=>[e(ae,null,{default:a(()=>l[9]||(l[9]=[p("Colis sélectionnés")])),_:1,__:[9]}),n("p",Kt,d(c.selectedTrackingNumbers.length)+" colis seront ajoutés au bon de livraison:",1),n("div",Ht,[(v(!0),y(J,null,fe(c.selectedTrackingNumbers,m=>(v(),A(P,{key:m,size:"small",color:"success",variant:"tonal",class:"font-mono"},{default:a(()=>[p(d(m),1)]),_:2},1024))),128))])]),_:1})])):b.value===3?(v(),y("div",Yt,[n("div",Jt,[e(x,{icon:"tabler-check-circle",size:"64",color:"success",class:"mb-4"}),l[11]||(l[11]=n("h6",{class:"text-h6 mb-2"},"Bon de livraison créé avec succès",-1)),n("p",Wt,[l[10]||(l[10]=p(" Référence: ")),e(P,{size:"small",color:"success",variant:"tonal"},{default:a(()=>[p(d(S.value),1)]),_:1})])]),e(te,{type:"success",variant:"tonal",class:"mb-4"},{default:a(()=>[e(ae,null,{default:a(()=>l[12]||(l[12]=[p("Prêt pour téléchargement")])),_:1,__:[12]}),l[13]||(l[13]=n("p",{class:"mb-0"}," Votre bon de livraison est maintenant disponible au téléchargement en différents formats. ",-1))]),_:1,__:[13]}),n("div",Qt,[(v(!0),y(J,null,fe(C.value,m=>(v(),A(k,{key:m.key,color:m.color,variant:"outlined",block:"",href:m.url,target:"_blank",disabled:!m.url},{default:a(()=>[e(x,{start:"",icon:m.icon},null,8,["icon"]),p(" "+d(m.label),1)]),_:2},1032,["color","href","disabled"]))),128))])])):w("",!0),h.value?(v(),y("div",Xt,[e($e,{indeterminate:"",color:"primary"}),n("p",Zt,d($.value),1)])):w("",!0),f.value?(v(),y("div",ea,[e(te,{type:"error",variant:"tonal",class:"mb-4"},{default:a(()=>[e(ae,null,{default:a(()=>[p(d(_(T)("admin_delivery_note_error_title")),1)]),_:1}),n("p",ta,d(f.value),1)]),_:1})])):w("",!0)]),_:1}),e(ie),e(be,{class:"pa-6"},{default:a(()=>[b.value>1&&b.value<3?(v(),A(k,{key:0,color:"secondary",variant:"outlined",onClick:i,disabled:h.value},{default:a(()=>[e(x,{start:"",icon:"tabler-arrow-left"}),l[14]||(l[14]=p(" Précédent "))]),_:1,__:[14]},8,["disabled"])):w("",!0),e(X),e(k,{color:"secondary",variant:"text",onClick:l[1]||(l[1]=m=>N(!1)),disabled:h.value},{default:a(()=>[p(d(b.value===3?_(T)("actions.close"):_(T)("actions.cancel")),1)]),_:1},8,["disabled"]),b.value===1?(v(),A(k,{key:1,color:"primary",variant:"elevated",onClick:L,loading:h.value},{default:a(()=>[e(x,{start:"",icon:"tabler-plus"}),l[15]||(l[15]=p(" Créer "))]),_:1,__:[15]},8,["loading"])):b.value===2?(v(),A(k,{key:2,color:"primary",variant:"elevated",onClick:u,loading:h.value},{default:a(()=>[e(x,{start:"",icon:"tabler-package-import"}),l[16]||(l[16]=p(" Ajouter et Sauvegarder "))]),_:1,__:[16]},8,["loading"])):w("",!0)]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),sa={class:"d-flex flex-column gap-6"},la={class:"d-flex justify-space-between align-center mb-6"},ia={class:"text-h4 font-weight-bold mb-1"},na={class:"text-body-1 mb-0"},ra={class:"d-flex gap-2"},oa={class:"d-flex align-center gap-2"},da={class:"font-weight-medium"},ua={class:"text-caption text-medium-emphasis"},ca={key:0,class:"text-caption text-info"},pa={class:"font-weight-bold"},_a={class:"text-body-2"},ma={class:"d-flex gap-1"},va={class:"text-center py-8"},fa={class:"text-h6 mb-2"},ga={class:"text-body-2 text-medium-emphasis"},ya={class:"mb-4"},ss=ge({__name:"index",setup(Z){const{t}=ze(),T=Qe(),V=et(),{confirm:F}=tt(),{showSuccess:b,showError:h}=at(),f=g(""),$=g(""),S=g(""),z=g(""),N=g(15),C=g([]),L=g([]),u=g(!1),i=g(!1),c=g(""),l=g(""),m=g(""),E=G(()=>V.isLoading),I=G(()=>V.shippingOrders),ne=G(()=>V.pagination),ee=[{title:t("code"),key:"id",sortable:!0},{title:t("tracking"),key:"tracking_number",sortable:!0},{title:t("client"),key:"client",sortable:!1},{title:t("city"),key:"city",sortable:!1},{title:t("status"),key:"status",sortable:!0},{title:t("total"),key:"total_ttc",sortable:!0},{title:t("updated"),key:"updated_at",sortable:!0},{title:t("actions"),key:"actions",sortable:!1}],Ie=[{title:t("all"),value:""},{title:t("pending"),value:"pending"},{title:t("received"),value:"received"},{title:t("in_transit"),value:"in_transit"},{title:t("shipped"),value:"shipped"},{title:t("at_facility"),value:"at_facility"},{title:t("ready_for_delivery"),value:"ready_for_delivery"},{title:t("out_for_delivery"),value:"out_for_delivery"},{title:t("delivery_attempted"),value:"delivery_attempted"},{title:t("delivered"),value:"delivered"},{title:t("returned"),value:"returned"},{title:t("refused"),value:"refused"},{title:t("cancelled"),value:"cancelled"},{title:t("unknown"),value:"unknown"}],K=async()=>{await V.fetchShippingOrders({q:f.value||void 0,status:$.value||void 0,from:S.value||void 0,to:z.value||void 0,perPage:N.value})},W=()=>{V.fetchShippingOrders({page:1,q:f.value||void 0,status:$.value||void 0,from:S.value||void 0,to:z.value||void 0,perPage:N.value})},Ne=r=>{V.fetchShippingOrders({page:r})},Re=r=>{r.length>0&&V.fetchShippingOrders({sort:r[0].key,dir:r[0].order})},Ae=r=>{T.push({name:"admin-orders-shipping-id",params:{id:r.id}})},re=g(!1),oe=g(null),H=g(!1),M=g(""),Y=g(""),de=g(!1),ue=g(!1),ce=g(!1),pe=g(null),ke=async r=>{Y.value=r.shipping_parcel.tracking_number,H.value=!0,M.value="";try{const[o,s]=await Promise.all([V.trackParcel(r.shipping_parcel.tracking_number),V.getParcelInfoNew(r.shipping_parcel.tracking_number)]);oe.value={tracking_info:o,parcel_info:s,parcel:r.shipping_parcel},re.value=!0}catch(o){M.value=o.message||t("admin_shipping_error_tracking"),h(M.value)}finally{H.value=!1}},xe=async()=>{if(Y.value){H.value=!0,M.value="";try{const[r,o]=await Promise.all([V.trackParcel(Y.value),V.getParcelInfoNew(Y.value)]),s=I.value.find(D=>{var R;return((R=D.shipping_parcel)==null?void 0:R.tracking_number)===Y.value});oe.value={tracking_info:r,parcel_info:o,parcel:s==null?void 0:s.shipping_parcel},b(t("admin_shipping_tracking_updated")),await K()}catch(r){M.value=r.message||t("admin_shipping_error_tracking_refresh"),h(M.value)}finally{H.value=!1}}},Ee=async r=>{const o=r.shipping_parcel.tracking_number;L.value.push(o);try{const s=await V.refreshTracking(o);s.success?b(t("admin_shipping_tracking_updated")):h(s.message||t("admin_shipping_error_tracking_update"))}catch(s){h(s.message||t("admin_shipping_error_tracking_update"))}finally{L.value=L.value.filter(s=>s!==o)}},Oe=async()=>{if(C.value.length===0){h(t("admin_shipping_error_select_order"));return}if(await F({title:t("admin_shipping_tracking_refresh"),text:t("admin_shipping_tracking_refresh_confirm",{count:C.value.length}),confirmText:t("admin_shipping_button_refresh"),cancelText:t("admin_shipping_button_cancel")}))try{const o=C.value.map(D=>{var B;const R=I.value.find(O=>O.id===D);return(B=R==null?void 0:R.shipping_parcel)==null?void 0:B.tracking_number}).filter(Boolean),s=await V.refreshTrackingBulk(o);b(s.message||t("admin_shipping_tracking_updated")),C.value=[]}catch(o){h(o.message||t("admin_shipping_error_tracking_update"))}},Pe=async r=>{pe.value=r,ue.value=!0},Fe=async r=>{if(pe.value){ce.value=!0;try{await V.resendToOzon(pe.value.id,r);const o=t(r==="ramassage"?"admin_shipping_mode_ramassage":"admin_shipping_mode_stock");b(t("admin_shipping_ozonexpress_resend",{mode:o})),await K()}catch(o){h(o.message||t("admin_shipping_error_ozonexpress_resend"))}finally{ce.value=!1}}},Le=()=>{},Ue=r=>{var o;c.value=r.id,l.value=((o=r.shipping_parcel)==null?void 0:o.status)||"",m.value="",u.value=!0},je=async()=>{if(!(!l.value||!c.value)){i.value=!0;try{await V.updateShippingStatus(c.value,{status:l.value,note:m.value||void 0}),b(`Statut mis à jour vers: ${Ve(l.value)}`+(l.value==="livree"?" (Commission créée automatiquement)":"")),u.value=!1,await K()}catch(r){h(r.message||"Erreur lors de la mise à jour du statut")}finally{i.value=!1}}},Me=()=>{u.value=!1,c.value="",l.value="",m.value=""},Be=async()=>{if(C.value.length===0){h("Veuillez sélectionner au moins une commande");return}de.value=!0},qe=r=>{b(`Bon de livraison créé avec succès: ${r}`),C.value=[],K()},Ge=r=>{switch(r==null?void 0:r.toLowerCase()){case"delivered":return"success";case"shipped":case"in_transit":case"out_for_delivery":return"info";case"pending":case"received":case"at_facility":case"ready_for_delivery":return"warning";case"cancelled":case"refused":case"delivery_attempted":return"error";case"returned":return"secondary";case"unknown":return"default";default:return"default"}},Ke=r=>({pending:t("admin_shipping_status_pending"),en_attente:t("admin_shipping_status_pending"),in_progress:t("admin_shipping_status_in_progress"),en_cours:t("admin_shipping_status_in_progress"),confirmed:t("admin_shipping_status_confirmed"),confirmee:t("admin_shipping_status_confirmed_fem"),picked_up:t("admin_shipping_status_picked_up"),collectee:t("admin_shipping_status_picked_up_fem"),shipped:t("admin_shipping_status_shipped"),in_transit:t("admin_shipping_status_in_transit"),at_facility:t("admin_shipping_status_at_facility"),expediee:t("admin_shipping_status_expedited"),ready_for_delivery:t("admin_shipping_status_ready_delivery"),out_for_delivery:t("admin_shipping_status_out_delivery"),delivery_attempted:t("admin_shipping_status_delivery_attempted"),delivered:t("admin_shipping_status_delivered"),livree:t("admin_shipping_status_delivered_fem"),returned:t("order.status.returned"),retournee:t("order.status.returned_feminine"),refused:t("admin_shipping_status_refused"),refusee:t("admin_shipping_status_refused_fem"),cancelled:t("admin_shipping_status_cancelled"),annulee:t("admin_shipping_status_cancelled_fem"),unknown:t("admin_shipping_status_unknown")})[r==null?void 0:r.toLowerCase()]||r||t("admin_shipping_status_unknown"),Ve=r=>Ke(r),He=r=>new Intl.NumberFormat("fr-MA",{style:"currency",currency:"MAD"}).format(r),Ye=r=>new Date(r).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),Je=r=>{var o,s;return((o=r.client_final_data)==null?void 0:o.nom_complet)||((s=r.client)==null?void 0:s.nom_complet)||t("admin_shipping_client_na")},We=r=>{var o,s;return((o=r.client_final_data)==null?void 0:o.telephone)||((s=r.client)==null?void 0:s.telephone)||t("admin_shipping_client_na")},Ce=r=>{var o,s,D;return((o=r.client_final_data)==null?void 0:o.ville)||((s=r.shipping_parcel)==null?void 0:s.city_name)||((D=r.adresse)==null?void 0:D.ville)||null},we=()=>{f.value="",$.value="",S.value="",z.value="",V.resetFilters(),K()},_e=(r,o)=>{let s="";switch(o){case"pdf":s=`https://client.ozoneexpress.ma/pdf-delivery-note?dn-ref=${r}`;break;case"a4":s=`https://client.ozoneexpress.ma/pdf-delivery-note-tickets?dn-ref=${r}`;break;case"100x100":s=`https://client.ozoneexpress.ma/pdf-delivery-note-tickets-4-4?dn-ref=${r}`;break}s&&window.open(s,"_blank")};return Xe(()=>{K()}),(r,o)=>(v(),y("div",sa,[n("div",la,[n("div",null,[n("h1",ia,d(_(t)("admin_shipping_title")),1),n("p",na,d(_(t)("admin_shipping_description")),1)]),n("div",ra,[e(k,{color:"success",variant:"outlined",disabled:C.value.length===0,onClick:Oe},{default:a(()=>[e(x,{start:"",icon:"tabler-refresh"}),p(" "+d(_(t)("admin_shipping_button_refresh_bulk",{count:C.value.length})),1)]),_:1},8,["disabled"]),e(k,{color:"secondary",variant:"outlined",disabled:C.value.length===0,onClick:Be},{default:a(()=>[e(x,{start:"",icon:"tabler-file-plus"}),p(" "+d(_(t)("admin_shipping_button_delivery_note_bulk",{count:C.value.length})),1)]),_:1},8,["disabled"]),e(k,{color:"primary",variant:"elevated",onClick:we},{default:a(()=>[e(x,{start:"",icon:"tabler-refresh"}),p(" "+d(_(t)("admin_shipping_button_refresh")),1)]),_:1})])]),e(j,{class:"mb-6"},{default:a(()=>[e(q,null,{default:a(()=>[e(De,null,{default:a(()=>[e(U,{cols:"12",md:"3"},{default:a(()=>[e(me,{modelValue:f.value,"onUpdate:modelValue":o[0]||(o[0]=s=>f.value=s),label:_(t)("search"),placeholder:_(t)("admin_shipping_search_placeholder"),"prepend-inner-icon":"tabler-search",clearable:"",onInput:W},null,8,["modelValue","label","placeholder"])]),_:1}),e(U,{cols:"12",md:"2"},{default:a(()=>[e(ve,{modelValue:$.value,"onUpdate:modelValue":[o[1]||(o[1]=s=>$.value=s),W],label:_(t)("status"),items:Ie,clearable:""},null,8,["modelValue","label"])]),_:1}),e(U,{cols:"12",md:"2"},{default:a(()=>[e(me,{modelValue:S.value,"onUpdate:modelValue":o[2]||(o[2]=s=>S.value=s),label:_(t)("date_from"),type:"date",onChange:W},null,8,["modelValue","label"])]),_:1}),e(U,{cols:"12",md:"2"},{default:a(()=>[e(me,{modelValue:z.value,"onUpdate:modelValue":o[3]||(o[3]=s=>z.value=s),label:_(t)("date_to"),type:"date",onChange:W},null,8,["modelValue","label"])]),_:1}),e(U,{cols:"12",md:"2"},{default:a(()=>[e(ve,{modelValue:N.value,"onUpdate:modelValue":[o[4]||(o[4]=s=>N.value=s),W],label:_(t)("per_page"),items:[10,15,25,50]},null,8,["modelValue","label"])]),_:1}),e(U,{cols:"12",md:"1"},{default:a(()=>[e(k,{color:"secondary",variant:"outlined",block:"",onClick:we},{default:a(()=>[e(x,{icon:"tabler-filter-off"})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(j,null,{default:a(()=>[e(ot,{"items-per-page":N.value,"onUpdate:itemsPerPage":o[5]||(o[5]=s=>N.value=s),modelValue:C.value,"onUpdate:modelValue":o[6]||(o[6]=s=>C.value=s),headers:ee,items:I.value,"items-length":ne.value.total,loading:E.value,page:ne.value.current_page,"show-select":"","item-value":"id","onUpdate:page":Ne,"onUpdate:sortBy":Re},{"item.tracking_number":a(({item:s})=>[n("div",oa,[e(P,{size:"small",color:"primary",variant:"tonal",class:"font-mono"},{default:a(()=>[p(d(s.shipping_parcel.tracking_number),1)]),_:2},1024),e(k,{size:"x-small",icon:"tabler-eye",variant:"text",onClick:D=>ke(s)},null,8,["onClick"])])]),"item.client":a(({item:s})=>[n("div",null,[n("div",da,d(Je(s)),1),n("div",ua,d(We(s)),1),Ce(s)?(v(),y("div",ca,d(Ce(s)),1)):w("",!0)])]),"item.city":a(({item:s})=>[e(P,{size:"small",color:"info",variant:"tonal"},{default:a(()=>[p(d(s.shipping_parcel.city_name||s.adresse.ville),1)]),_:2},1024)]),"item.status":a(({item:s})=>[e(P,{size:"small",color:Ge(s.shipping_parcel.status),variant:"tonal"},{default:a(()=>[p(d(Ve(s.shipping_parcel.status)),1)]),_:2},1032,["color"])]),"item.total_ttc":a(({item:s})=>[n("div",pa,d(He(s.total_ttc)),1)]),"item.updated_at":a(({item:s})=>[n("div",_a,d(Ye(s.updated_at)),1)]),"item.actions":a(({item:s})=>{var D,R,B;return[n("div",ma,[e(k,{size:"small",color:"primary",variant:"text",icon:"tabler-eye",onClick:O=>Ae(s)},null,8,["onClick"]),e(Q,{activator:"prev",location:"top"},{default:a(()=>[p(d(_(t)("actions.viewDetails")),1)]),_:1}),(D=s.shipping_parcel)!=null&&D.tracking_number?(v(),y(J,{key:1},[e(k,{size:"small",color:"info",variant:"text",icon:"tabler-route",loading:H.value,onClick:O=>ke(s)},null,8,["loading","onClick"]),e(Q,{activator:"prev",location:"top"},{default:a(()=>[p(d(_(t)("actions.viewTracking")),1)]),_:1}),e(k,{size:"small",color:"success",variant:"text",icon:"tabler-refresh",loading:L.value.includes((R=s.shipping_parcel)==null?void 0:R.tracking_number),onClick:O=>Ee(s)},null,8,["loading","onClick"]),e(Q,{activator:"prev",location:"top"},{default:a(()=>[p(d(_(t)("admin_shipping_tooltip_refresh_tracking")),1)]),_:1})],64)):(v(),y(J,{key:0},[e(k,{size:"small",color:"warning",variant:"text",icon:"tabler-truck",onClick:O=>Pe(s)},null,8,["onClick"]),e(Q,{activator:"prev",location:"top"},{default:a(()=>[p(d(_(t)("admin_shipping_tooltip_resend_ozon")),1)]),_:1})],64)),(B=s.shipping_parcel)!=null&&B.sent_to_carrier?w("",!0):(v(),y(J,{key:2},[e(k,{size:"small",color:"warning",variant:"text",icon:"tabler-edit",onClick:O=>Ue(s)},null,8,["onClick"]),e(Q,{activator:"prev",location:"top"},{default:a(()=>[p(d(_(t)("admin_shipping_tooltip_modify_status")),1)]),_:1})],64)),e(dt,null,{activator:a(({props:O})=>[e(k,Ze({size:"small",color:"secondary",variant:"text",icon:"tabler-file-download"},O),null,16)]),default:a(()=>[e(ut,null,{default:a(()=>[s.shipping_parcel.delivery_note_ref?(v(),A(se,{key:0,onClick:O=>_e(s.shipping_parcel.delivery_note_ref,"pdf")},{default:a(()=>[e(le,null,{default:a(()=>[p(d(_(t)("pdf_standard")),1)]),_:1})]),_:2},1032,["onClick"])):w("",!0),s.shipping_parcel.delivery_note_ref?(v(),A(se,{key:1,onClick:O=>_e(s.shipping_parcel.delivery_note_ref,"a4")},{default:a(()=>[e(le,null,{default:a(()=>[p(d(_(t)("labels_a4")),1)]),_:1})]),_:2},1032,["onClick"])):w("",!0),s.shipping_parcel.delivery_note_ref?(v(),A(se,{key:2,onClick:O=>_e(s.shipping_parcel.delivery_note_ref,"100x100")},{default:a(()=>[e(le,null,{default:a(()=>[p(d(_(t)("labels_100x100")),1)]),_:1})]),_:2},1032,["onClick"])):w("",!0),s.shipping_parcel.delivery_note_ref?w("",!0):(v(),A(se,{key:3},{default:a(()=>[e(le,{class:"text-medium-emphasis"},{default:a(()=>[p(d(_(t)("no_delivery_note")),1)]),_:1})]),_:1}))]),_:2},1024)]),_:2},1024)])]}),"no-data":a(()=>[n("div",va,[e(x,{icon:"tabler-truck-off",size:"64",class:"mb-4",color:"disabled"}),n("h3",fa,d(_(t)("no_shipped_orders")),1),n("p",ga,d(_(t)("no_orders_sent_ozonexpress")),1)])]),_:1},8,["items-per-page","modelValue","items","items-length","loading","page"])]),_:1}),e(Ut,{modelValue:re.value,"onUpdate:modelValue":o[7]||(o[7]=s=>re.value=s),"tracking-number":Y.value,"tracking-data":oe.value,loading:H.value,error:M.value,onRefresh:xe,onRetry:xe},null,8,["modelValue","tracking-number","tracking-data","loading","error"]),e(rt,{modelValue:ue.value,"onUpdate:modelValue":o[8]||(o[8]=s=>ue.value=s),loading:ce.value,title:_(t)("admin_shipping_resend_ozon_title"),text:_(t)("admin_shipping_resend_ozon_text"),"default-mode":"ramassage",onConfirm:Fe,onCancel:Le},null,8,["modelValue","loading","title","text"]),e(aa,{modelValue:de.value,"onUpdate:modelValue":o[9]||(o[9]=s=>de.value=s),"selected-tracking-numbers":C.value.map(s=>{var R;const D=I.value.find(B=>B.id===s);return(R=D==null?void 0:D.shipping_parcel)==null?void 0:R.tracking_number}).filter(Boolean),onCreated:qe},null,8,["modelValue","selected-tracking-numbers"]),e(he,{modelValue:u.value,"onUpdate:modelValue":o[12]||(o[12]=s=>u.value=s),"max-width":"500",persistent:""},{default:a(()=>[e(j,null,{default:a(()=>[e(ye,{class:"text-h6"},{default:a(()=>[e(x,{start:"",icon:"tabler-edit",color:"warning"}),p(" "+d(_(t)("admin_shipping_modify_status_title")),1)]),_:1}),e(q,null,{default:a(()=>[n("p",ya,[p(d(_(t)("admin_shipping_modify_status_description"))+" ",1),n("strong",null,d(_(t)("admin_shipping_modify_status_note"))+":",1),p(" "+d(_(t)("admin_shipping_modify_status_note_commission")),1)]),e(ve,{modelValue:l.value,"onUpdate:modelValue":o[10]||(o[10]=s=>l.value=s),label:_(t)("admin_shipping_new_status"),items:[{title:_(t)("admin_shipping_status_pending"),value:"pending"},{title:_(t)("admin_shipping_status_shipped"),value:"expediee"},{title:_(t)("admin_shipping_status_delivered_fem"),value:"livree"},{title:_(t)("admin_shipping_status_refused_fem"),value:"refusee"},{title:_(t)("order.status.returned_feminine"),value:"retournee"},{title:_(t)("admin_shipping_status_cancelled_fem"),value:"annulee"}],variant:"outlined",class:"mb-4"},null,8,["modelValue","label","items"]),e(ct,{modelValue:m.value,"onUpdate:modelValue":o[11]||(o[11]=s=>m.value=s),label:_(t)("admin_shipping_note_optional"),placeholder:_(t)("admin_shipping_note_placeholder"),rows:"3",variant:"outlined"},null,8,["modelValue","label","placeholder"])]),_:1}),e(be,null,{default:a(()=>[e(X),e(k,{variant:"text",onClick:Me,disabled:i.value},{default:a(()=>[p(d(_(t)("admin_shipping_cancel")),1)]),_:1},8,["disabled"]),e(k,{color:"warning",variant:"elevated",loading:i.value,disabled:!l.value,onClick:je},{default:a(()=>[e(x,{start:"",icon:"tabler-check"}),p(" "+d(_(t)("admin_shipping_update")),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}});export{ss as default};
