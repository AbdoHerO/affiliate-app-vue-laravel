import{b5 as q,r as m,V as w,ba as f}from"./main-DEzoUo6n.js";import{u as I}from"./useNotifications-Bc6GUAmT.js";const Q=q("admin-tickets",()=>{const d=m([]),p=m(null),h=m([]),S=m(null),l=m(!1),k=m(!1),F=m(null),T=m({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0}),_=m({current_page:1,last_page:1,per_page:20,total:0,from:0,to:0}),b=m({page:1,per_page:15,sort:"last_activity_at",dir:"desc"}),E=w(()=>d.value.length>0),O=w(()=>T.value.total),M=w(()=>h.value.length>0),x=w(()=>_.value.total),{showSuccess:v,showError:A}=I(),i=e=>{F.value=e,A(e)},g=()=>{F.value=null},$=async(e={})=>{var c,n;if(!l.value){l.value=!0,g();try{const t={...b.value},s={...t,...e};JSON.stringify(t)!==JSON.stringify(s)&&(b.value=s);const r=new URLSearchParams;Object.entries(s).forEach(([P,y])=>{y!=null&&y!==""&&(Array.isArray(y)?y.forEach(D=>r.append(`${P}[]`,String(D))):r.append(P,String(y)))});const u=`/admin/support/tickets${r.toString()?`?${r.toString()}`:""}`;console.log("ðŸŽ« [Store] Fetching tickets from:",u);const o=await f(u);console.log("ðŸŽ« [Store] API Response:",o),o!=null&&o.success||o!=null&&o.data?(d.value=o.data||o.tickets||[],T.value=o.pagination||o.meta||{current_page:1,last_page:1,per_page:15,total:0,from:0,to:0},console.log("âœ… [Store] Tickets loaded:",d.value.length)):(console.error("âŒ [Store] API returned error:",o),i((o==null?void 0:o.message)||"Failed to fetch tickets"))}catch(t){console.error("ðŸš« [Store] Fetch tickets error:",t);const s=((n=(c=t.response)==null?void 0:c.data)==null?void 0:n.message)||t.message||"Failed to fetch tickets";i(s)}finally{l.value=!1}}};return{tickets:d,currentTicket:p,messages:h,statistics:S,loading:l,messagesLoading:k,error:F,pagination:T,messagesPagination:_,filters:b,hasTickets:E,totalTickets:O,hasMessages:M,totalMessages:x,fetchTickets:$,fetchStatistics:async()=>{try{const e=await f("/admin/support/tickets/statistics");(e!=null&&e.success||e!=null&&e.data)&&(S.value=e.data||e.statistics,console.log("âœ… [Store] Statistics loaded:",S.value))}catch(e){console.error("ðŸš« [Store] Failed to fetch ticket statistics:",e)}},fetchTicket:async e=>{var c,n;l.value=!0,g();try{const t=await f(`/admin/support/tickets/${e}`);return t.success?(p.value=t.data,t.data):(i(t.message||"Failed to fetch ticket"),null)}catch(t){return i(((n=(c=t.response)==null?void 0:c.data)==null?void 0:n.message)||"Failed to fetch ticket"),null}finally{l.value=!1}},createTicket:async e=>{var c,n;l.value=!0,g();try{const t=new FormData;t.append("subject",e.subject),t.append("category",e.category),t.append("priority",e.priority),t.append("requester_id",e.requester_id),e.relations&&e.relations.forEach((a,r)=>{t.append(`relations[${r}][related_type]`,a.related_type),t.append(`relations[${r}][related_id]`,a.related_id)}),e.first_message&&(t.append("first_message[body]",e.first_message.body),e.first_message.type&&t.append("first_message[type]",e.first_message.type),e.first_message.attachments&&e.first_message.attachments.forEach((a,r)=>{t.append(`first_message[attachments][${r}]`,a)}));const s=await f("/admin/support/tickets",{method:"POST",body:t});return s.success?(v(s.message),await $(),s.data):(i(s.message||"Failed to create ticket"),null)}catch(t){return i(((n=(c=t.response)==null?void 0:c.data)==null?void 0:n.message)||"Failed to create ticket"),null}finally{l.value=!1}},updateTicket:async(e,c)=>{var n,t,s;l.value=!0,g();try{const a=await f(`/admin/support/tickets/${e}`,{method:"POST",body:c});if(a.success){v(a.message),((n=p.value)==null?void 0:n.id)===e&&(p.value=a.data);const r=d.value.findIndex(u=>u.id===e);return r!==-1&&(d.value[r]=a.data),a.data}else return i(a.message||"Failed to update ticket"),null}catch(a){return i(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to update ticket"),null}finally{l.value=!1}},assignTicket:async(e,c)=>{var n,t,s;l.value=!0,g();try{const a=await f(`/admin/support/tickets/${e}/assign`,{method:"POST",body:{assignee_id:c}});if(a.success){v(a.message),((n=p.value)==null?void 0:n.id)===e&&(p.value=a.data);const r=d.value.findIndex(u=>u.id===e);return r!==-1&&(d.value[r]=a.data),a.data}else return i(a.message||"Failed to assign ticket"),null}catch(a){return i(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to assign ticket"),null}finally{l.value=!1}},changeStatus:async(e,c)=>{var n,t,s;l.value=!0,g();try{const a=await f(`/admin/support/tickets/${e}/status`,{method:"POST",body:{status:c}});if(a.success){v(a.message),((n=p.value)==null?void 0:n.id)===e&&(p.value=a.data);const r=d.value.findIndex(u=>u.id===e);return r!==-1&&(d.value[r]=a.data),a.data}else return i(a.message||"Failed to change ticket status"),null}catch(a){return i(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to change ticket status"),null}finally{l.value=!1}},deleteTicket:async e=>{var c,n,t;l.value=!0,g();try{const s=await f(`/admin/support/tickets/${e}`,{method:"DELETE"});return s.success?(v(s.message),d.value=d.value.filter(a=>a.id!==e),((c=p.value)==null?void 0:c.id)===e&&(p.value=null),!0):(i(s.message||"Failed to delete ticket"),!1)}catch(s){return i(((t=(n=s.response)==null?void 0:n.data)==null?void 0:t.message)||"Failed to delete ticket"),!1}finally{l.value=!1}},bulkAction:async(e,c,n)=>{var t,s,a;l.value=!0,g();try{const r={action:e,ticket_ids:c,...n},u=await f("/admin/support/tickets/bulk-action",{method:"POST",body:r});return u.success?(v(u.message),await $(),((t=u.data)==null?void 0:t.updated_count)||0):(i(u.message||"Failed to perform bulk action"),0)}catch(r){return i(((a=(s=r.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to perform bulk action"),0}finally{l.value=!1}},fetchMessages:async(e,c=1)=>{var n,t;k.value=!0,g();try{const s=new URLSearchParams;s.append("page",String(c)),s.append("per_page",String(_.value.per_page));const a=`/admin/support/tickets/${e}/messages?${s.toString()}`,r=await f(a);return r.success?(c===1?h.value=r.data:h.value.push(...r.data),_.value=r.pagination,r.data):(i(r.message||"Failed to fetch messages"),[])}catch(s){return i(((t=(n=s.response)==null?void 0:n.data)==null?void 0:t.message)||"Failed to fetch messages"),[]}finally{k.value=!1}},addMessage:async(e,c)=>{var n,t,s;k.value=!0,g();try{const a=new FormData;a.append("type",c.type),a.append("body",c.body),c.attachments&&c.attachments.forEach((u,o)=>{a.append(`attachments[${o}]`,u)});const r=await f(`/admin/support/tickets/${e}/messages`,{method:"POST",body:a});return r.success?(v(r.message),h.value.push(r.data),((n=p.value)==null?void 0:n.id)===e&&(p.value.last_activity_at=r.data.created_at),r.data):(i(r.message||"Failed to send message"),null)}catch(a){return i(((s=(t=a.response)==null?void 0:t.data)==null?void 0:s.message)||"Failed to send message"),null}finally{k.value=!1}},resetState:()=>{d.value=[],p.value=null,h.value=[],S.value=null,F.value=null,T.value={current_page:1,last_page:1,per_page:15,total:0,from:0,to:0},_.value={current_page:1,last_page:1,per_page:20,total:0,from:0,to:0},b.value={page:1,per_page:15,sort:"last_activity_at",dir:"desc"}},clearError:g}});export{Q as u};
