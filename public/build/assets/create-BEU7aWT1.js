const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/useConfirmAction-BkzLltMc.js","assets/main-BGmfaZsq.js","assets/main-DBTJy9Ru.css"])))=>i.map(i=>d[i]);
import{d as re,k as le,aL as oe,c$ as se,aY as ie,r as u,V as T,o as ne,bb as ce,w as ue,c as $,b as w,h as de,e as s,aU as me,g as i,t as m,v as g,f as y,az as q,ac as j,aW as ge,b0 as fe,b1 as ve,ba as V}from"./main-BGmfaZsq.js";import{u as pe}from"./useNotifications-TnKci45M.js";import{u as ke}from"./useSafeNavigation-Cd-eZjzM.js";import{V as Ce}from"./VAlert-CPLjIjOe.js";import{V as ye}from"./VCardText-BzdllyhI.js";import{V as he}from"./VForm-9k5StL4q.js";import{V as _e,a as v}from"./VRow-Jzvhbj9T.js";import{V as be}from"./VTextField-STn8GDXm.js";import{V as Te}from"./VTextarea-Dm9Swusq.js";import{V as U}from"./VSelect-BYn5Cf2R.js";import{V as we}from"./VAutocomplete-3NZOM7ei.js";import{a as Ve,b as Ue,d as xe}from"./VList-DVfzin0E.js";import{V as Ae}from"./VAvatar-CXniQsPN.js";import{V as Ee}from"./VCard-hQ_o7lvO.js";import{_ as Se}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./createSimpleFunctional-BjWjRu3X.js";import"./VField-BqE6uwOn.js";import"./VImg-6pMKiBpi.js";import"./forwardRefs-BxxmAO9z.js";/* empty css              */import"./dialog-transition-BhMeiVQ2.js";import"./VMenu-C3I-a7hP.js";import"./VOverlay-CvSSR2rW.js";import"./lazy-DgLfxsl0.js";import"./VCheckboxBtn-DO9961XV.js";import"./VChip-S_h5DeIW.js";import"./filter-578zAk0s.js";import"./ssrBoot-A30zOnZp.js";import"./VDivider-oo2GmB8o.js";const Pe={class:"create-ticket-page"},Le={key:0,class:"d-flex justify-center align-center",style:{"min-height":"200px"}},Re={key:2},Ie={class:"d-flex justify-space-between align-center mb-6"},Fe={class:"text-h4 font-weight-bold mb-1"},Ne={class:"text-body-1 text-medium-emphasis"},ze={class:"d-flex gap-3"},$e=re({__name:"create",async setup(qe){let h,O;const M=le(),{t:W}=oe(),{showSuccess:Y,showError:x}=pe(),{safePush:A}=ke();let E,S;try{console.log("ğŸ« [Create Ticket] Initializing confirm composable...");const{useQuickConfirm:a}=([h,O]=se(()=>ie(()=>import("./useConfirmAction-BkzLltMc.js"),__vite__mapDeps([0,1,2]))),h=await h,O(),h),t=a();if(t&&typeof t=="object")E=t.confirm||(()=>Promise.resolve(!0)),S=t.presets||{cancel:()=>({title:"Confirm Cancel",text:"Are you sure you want to cancel? Unsaved changes will be lost."})},console.log("âœ… [Create Ticket] Confirm composable initialized successfully");else throw new Error("useQuickConfirm returned invalid object")}catch(a){console.error("ğŸš« [Create Ticket] Error initializing confirm composable:",a),E=async t=>{console.log("ğŸ”„ [Create Ticket] Using fallback confirm dialog");const e=(t==null?void 0:t.text)||(t==null?void 0:t.title)||"Are you sure?";return window.confirm(e)},S={cancel:()=>({title:"Cancel Creation",text:"Are you sure you want to cancel? Unsaved changes will be lost.",type:"warning",confirmText:"Yes, Cancel",cancelText:"Continue Editing",icon:"tabler-x",color:"warning"})}}const P=u(!1),L=u(!1),_=u([]),f=u([]),R=u(!1),d=u([]),p=u(!1),I=u(!1),k=u(!1),b=u(""),C=u(!1),l=u({title:"",description:"",priority:"normal",category_id:"general",user_id:null,assignee_id:null,status:"open",tags:[],attachments:[]}),Q=T(()=>{try{return(_==null?void 0:_.value)||[]}catch(a){return console.error("ğŸš« [Create Ticket] Error accessing categories:",a),[]}}),G=T(()=>{try{return(f==null?void 0:f.value)||[]}catch(a){return console.error("ğŸš« [Create Ticket] Error accessing users:",a),[]}}),H=T(()=>{try{return(L==null?void 0:L.value)||I.value||!1}catch(a){return console.error("ğŸš« [Create Ticket] Error accessing loading state:",a),!1}}),B=T(()=>{var a,t;try{return!C.value&&((a=l.value.title)==null?void 0:a.trim())&&((t=l.value.description)==null?void 0:t.trim())&&l.value.user_id}catch(e){return console.error("ğŸš« [Create Ticket] Error in canSubmit computed:",e),!1}}),K=[{value:"low",label:"Low",color:"success"},{value:"normal",label:"Normal",color:"info"},{value:"high",label:"High",color:"warning"},{value:"urgent",label:"Urgent",color:"error"}],J=[{value:"open",label:"Open",color:"info"},{value:"pending",label:"Pending",color:"warning"},{value:"waiting_user",label:"Waiting User",color:"secondary"},{value:"waiting_third_party",label:"Waiting Third Party",color:"secondary"},{value:"resolved",label:"Resolved",color:"success"},{value:"closed",label:"Closed",color:"default"}],c=(a,t)=>{try{return W(a)}catch(e){return console.error(`ğŸš« [Create Ticket] Translation error for key: ${a}`,e),t||a}},X=async()=>{try{console.log("ğŸ« [Create Ticket] Loading ticket categories..."),_.value=[{value:"general",title:"General"},{value:"orders",title:"Orders"},{value:"payments",title:"Payments"},{value:"commissions",title:"Commissions"},{value:"kyc",title:"KYC"},{value:"technical",title:"Technical"},{value:"other",title:"Other"}],console.log("âœ… [Create Ticket] Categories loaded successfully")}catch(a){console.error("ğŸš« [Create Ticket] Error loading categories:",a)}},Z=async a=>{var t,e;R.value=!0;try{console.log("ğŸ« [Create Ticket] Loading users...");const r=new URLSearchParams;r.append("per_page","100");const n=`/admin/users${r.toString()?`?${r.toString()}`:""}`;console.log("ğŸ” [Create Ticket] Fetching users from:",n);const o=await V(n);console.log("ğŸ“¥ [Create Ticket] API Response:",o),o!=null&&o.users||(t=o==null?void 0:o.data)!=null&&t.users?(f.value=o.users||((e=o.data)==null?void 0:e.users)||[],console.log("âœ… [Create Ticket] Users loaded:",f.value.length)):o!=null&&o.data&&Array.isArray(o.data)?(f.value=o.data,console.log("âœ… [Create Ticket] Users loaded from data array:",f.value.length)):(console.error("âŒ [Create Ticket] API returned unexpected format:",o),x("Unexpected response format from server"))}catch(r){console.error("ğŸš« [Create Ticket] Error loading users:",r),x("Error loading users")}finally{R.value=!1}},F=async()=>{var a;p.value=!0;try{const e=`/admin/users?${new URLSearchParams({per_page:"50",role:"admin"}).toString()}`;console.log("ğŸ” [Create Ticket] Loading admin users from:",e);const r=await V(e);if(console.log("ğŸ” [Create Ticket] Admin users response:",r),console.log("ğŸ” [Create Ticket] Total users returned:",((a=r==null?void 0:r.users)==null?void 0:a.length)||0),r!=null&&r.users&&Array.isArray(r.users)){const n=r.users.filter(o=>{const N=o.roles&&o.roles.some(z=>z.name==="admin");return console.log(`ğŸ” User ${o.nom_complet} has admin role:`,N),N});console.log("ğŸ” [Create Ticket] Admin users after filtering:",n.length),d.value=n.map(o=>({...o,nom_complet:o.nom_complet||o.name||"Unknown User",email:o.email||""})),console.log("âœ… [Create Ticket] Final admin users for dropdown:",d.value)}else console.log("âŒ [Create Ticket] No users in response"),d.value=[]}catch(t){console.error("âŒ [Create Ticket] Failed to load admin users:",t),d.value=[]}finally{p.value=!1}},ee=async a=>{if(console.log("ğŸ” [Create Ticket] Search triggered with query:",a),!a||a.length<2){console.log("ğŸ” [Create Ticket] No query, loading initial admin users"),await F();return}p.value=!0;try{const e=`/admin/users?${new URLSearchParams({search:a,per_page:"20",role:"admin"}).toString()}`;console.log("ğŸ” [Create Ticket] Searching admin users from:",e);const r=await V(e);if(console.log("ğŸ” [Create Ticket] Search admin users response:",r),r!=null&&r.users&&Array.isArray(r.users)){const n=r.users.filter(o=>o.roles&&o.roles.some(z=>z.name==="admin"));console.log("ğŸ” [Create Ticket] Admin users found in search:",n.length),d.value=n.map(o=>({...o,nom_complet:o.nom_complet||o.name||"Unknown User",email:o.email||""}))}else d.value=[]}catch(t){console.error("âŒ [Create Ticket] Failed to search admin users:",t),d.value=[]}finally{p.value=!1}},te=async a=>{var t;try{console.log("ğŸ« [Create Ticket] Making API call to create ticket:",a);const e=await V("/admin/support/tickets",{method:"POST",body:a});return console.log("ğŸ“¥ [Create Ticket] API Response:",e),e!=null&&e.success||e!=null&&e.ticket||e!=null&&e.data?{success:!0,ticket:e.ticket||e.data,message:e.message||"Ticket created successfully"}:{success:!1,message:(e==null?void 0:e.message)||(e==null?void 0:e.error)||"Failed to create ticket"}}catch(e){return console.error("ğŸš« [Create Ticket] API Error:",e),(t=e==null?void 0:e.data)!=null&&t.message?{success:!1,message:e.data.message}:e!=null&&e.message?{success:!1,message:e.message}:{success:!1,message:"Network error occurred"}}},D=async()=>{var a,t;if(!B.value){console.warn("ğŸš« [Create Ticket] Cannot submit - form validation failed");return}try{if(C.value=!0,k.value=!1,b.value="",console.log("ğŸ« [Create Ticket] Submitting ticket form:",l.value),!((a=l.value.title)!=null&&a.trim()))throw new Error("Title is required");if(!((t=l.value.description)!=null&&t.trim()))throw new Error("Description is required");if(!l.value.user_id)throw new Error("User is required");const e={subject:l.value.title.trim(),category:l.value.category_id||"general",priority:l.value.priority||"normal",status:l.value.status||"open",requester_id:l.value.user_id,assignee_id:l.value.assignee_id||null,first_message:{body:l.value.description.trim(),attachments:l.value.attachments||[]},tags:l.value.tags||[]};console.log("ğŸ« [Create Ticket] Prepared ticket data:",e);const r=await te(e);if(r!=null&&r.success)console.log("âœ… [Create Ticket] Ticket created successfully"),Y("Ticket created successfully"),await A("/admin/support/tickets",{fallback:"/admin/dashboard",maxRetries:2});else throw new Error((r==null?void 0:r.message)||"Failed to create ticket")}catch(e){console.error("ğŸš« [Create Ticket] Error creating ticket:",e),k.value=!0,b.value=e.message||"An error occurred while creating the ticket",x(e.message||"Failed to create ticket")}finally{C.value=!1}},ae=async()=>{var a,t;try{if((((a=l.value.title)==null?void 0:a.trim())||((t=l.value.description)==null?void 0:t.trim())||l.value.user_id||l.value.assignee_id)&&!await E(S.cancel()))return;console.log("ğŸ« [Create Ticket] Cancelling ticket creation"),await A("/admin/support/tickets",{fallback:"/admin/dashboard",maxRetries:2})}catch(e){console.error("ğŸš« [Create Ticket] Error during cancel:",e),await A("/admin/support/tickets")}};return ne(async()=>{if(!P.value)try{console.log("ğŸ« [Create Ticket] Component mounted, initializing data..."),I.value=!0;const a=[X(),Z(),F()];(await Promise.allSettled(a)).forEach((e,r)=>{const n=["categories","users"][r];e.status==="fulfilled"?console.log(`âœ… [Create Ticket] ${n} loaded successfully`):console.warn(`âš ï¸ [Create Ticket] ${n} failed to load:`,e.reason)}),console.log("âœ… [Create Ticket] Component initialization completed")}catch(a){console.error("ğŸš« [Create Ticket] Error during component initialization:",a),k.value=!0,b.value="Failed to load initial data"}finally{I.value=!1}}),ce(()=>{console.log("ğŸ« [Create Ticket] Component unmounting..."),P.value=!0}),ue(()=>M.currentRoute.value,a=>{P.value||console.log("ğŸ« [Create Ticket] Route changed:",a.path)},{immediate:!1}),(a,t)=>(w(),$("div",Pe,[H.value?(w(),$("div",Le,[s(me,{indeterminate:"",color:"primary",size:"64"})])):k.value?(w(),de(Ce,{key:1,type:"error",variant:"tonal",closable:"","onClick:close":t[0]||(t[0]=e=>k.value=!1),class:"mb-6"},{title:i(()=>[m(g(c("common.error","Error")),1)]),default:i(()=>[m(" "+g(b.value),1)]),_:1})):(w(),$("div",Re,[y("div",Ie,[y("div",null,[y("h1",Fe,g(c("tickets.create.title","Create New Ticket")),1),y("p",Ne,g(c("tickets.create.subtitle","Create a new support ticket")),1)]),y("div",ze,[s(j,{variant:"outlined",color:"default",onClick:ae,disabled:C.value},{default:i(()=>[s(q,{start:""},{default:i(()=>t[8]||(t[8]=[m("tabler-x")])),_:1,__:[8]}),m(" "+g(c("common.cancel","Cancel")),1)]),_:1},8,["disabled"]),s(j,{color:"primary",onClick:D,loading:C.value,disabled:!B.value},{default:i(()=>[s(q,{start:""},{default:i(()=>t[9]||(t[9]=[m("tabler-plus")])),_:1,__:[9]}),m(" "+g(c("tickets.create.submit","Create Ticket")),1)]),_:1},8,["loading","disabled"])])]),s(Ee,null,{default:i(()=>[s(ye,null,{default:i(()=>[s(he,{onSubmit:ge(D,["prevent"])},{default:i(()=>[s(_e,null,{default:i(()=>[s(v,{cols:"12"},{default:i(()=>[s(be,{modelValue:l.value.title,"onUpdate:modelValue":t[1]||(t[1]=e=>l.value.title=e),label:c("tickets.form.title","Title"),placeholder:c("tickets.form.title_placeholder","Enter ticket title"),variant:"outlined",required:"",rules:[e=>!!e||"Title is required"]},null,8,["modelValue","label","placeholder","rules"])]),_:1}),s(v,{cols:"12"},{default:i(()=>[s(Te,{modelValue:l.value.description,"onUpdate:modelValue":t[2]||(t[2]=e=>l.value.description=e),label:c("tickets.form.description","Description"),placeholder:c("tickets.form.description_placeholder","Enter ticket description"),variant:"outlined",rows:"4",required:"",rules:[e=>!!e||"Description is required"]},null,8,["modelValue","label","placeholder","rules"])]),_:1}),s(v,{cols:"12",md:"6"},{default:i(()=>[s(U,{modelValue:l.value.user_id,"onUpdate:modelValue":t[3]||(t[3]=e=>l.value.user_id=e),items:G.value,"item-title":"nom_complet","item-value":"id",label:c("tickets.form.user","User"),variant:"outlined",required:"",rules:[e=>!!e||"User is required"],loading:R.value,"no-data-text":c("common.no_data","No users available")},null,8,["modelValue","items","label","rules","loading","no-data-text"])]),_:1}),s(v,{cols:"12",md:"6"},{default:i(()=>[s(U,{modelValue:l.value.category_id,"onUpdate:modelValue":t[4]||(t[4]=e=>l.value.category_id=e),items:Q.value,"item-title":"title","item-value":"value",label:c("tickets.form.category","Category"),variant:"outlined",clearable:"","no-data-text":c("common.no_data","No categories available")},null,8,["modelValue","items","label","no-data-text"])]),_:1}),s(v,{cols:"12",md:"6"},{default:i(()=>[s(U,{modelValue:l.value.priority,"onUpdate:modelValue":t[5]||(t[5]=e=>l.value.priority=e),items:K,"item-title":"label","item-value":"value",label:c("tickets.form.priority","Priority"),variant:"outlined"},null,8,["modelValue","label"])]),_:1}),s(v,{cols:"12",md:"6"},{default:i(()=>[s(U,{modelValue:l.value.status,"onUpdate:modelValue":t[6]||(t[6]=e=>l.value.status=e),items:J,"item-title":"label","item-value":"value",label:c("tickets.form.status","Status"),variant:"outlined"},null,8,["modelValue","label"])]),_:1}),s(v,{cols:"12"},{default:i(()=>[s(we,{modelValue:l.value.assignee_id,"onUpdate:modelValue":t[7]||(t[7]=e=>l.value.assignee_id=e),items:d.value,loading:p.value,label:c("tickets.form.assignee","Assignee"),variant:"outlined",clearable:"","item-title":"nom_complet","item-value":"id",placeholder:"Search admin users...","onUpdate:search":ee,onFocus:F},{item:i(({props:e,item:r})=>[s(Ve,fe(ve(e)),{prepend:i(()=>[s(Ae,{size:"24"},{default:i(()=>[s(q,{icon:"tabler-user",size:"14"})]),_:1})]),default:i(()=>[s(Ue,null,{default:i(()=>{var n;return[m(g(((n=r.raw)==null?void 0:n.nom_complet)||"Unknown User"),1)]}),_:2},1024),s(xe,null,{default:i(()=>{var n;return[m(g(((n=r.raw)==null?void 0:n.email)||""),1)]}),_:2},1024)]),_:2},1040)]),_:1},8,["modelValue","items","loading","label"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]))]))}}),vt=Se($e,[["__scopeId","data-v-f9f9f332"]]);export{vt as default};
