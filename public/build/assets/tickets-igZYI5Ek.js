import{b5 as C,r as f,V as p,ba as v}from"./main-3LuWNv9W.js";import{u as S}from"./useTicketBadge-CTYgbW8m.js";const U=C("affiliateTickets",()=>{const{refresh:h}=S(),d=f([]),c=f(null),o=f({list:!1,detail:!1,create:!1,message:!1,status:!1}),n=f(null),m=f({current_page:1,last_page:1,per_page:15,total:0,from:null,to:null}),r=f({q:"",status:[],priority:[],category:[],date_from:"",date_to:"",sort:"last_activity_at",dir:"desc",per_page:15}),_=p(()=>d.value.length>0),k=p(()=>o.value.list),b=p(()=>o.value.detail),L=p(()=>o.value.create),E=p(()=>o.value.message),T=p(()=>o.value.status),y=async(e=1)=>{var a,i,s,l;o.value.list=!0,n.value=null;try{const t=new URLSearchParams;t.append("page",e.toString()),t.append("per_page",((a=r.value.per_page)==null?void 0:a.toString())||"15"),r.value.q&&t.append("q",r.value.q),(i=r.value.status)!=null&&i.length&&r.value.status.forEach(u=>t.append("status[]",u)),(s=r.value.priority)!=null&&s.length&&r.value.priority.forEach(u=>t.append("priority[]",u)),(l=r.value.category)!=null&&l.length&&r.value.category.forEach(u=>t.append("category[]",u)),r.value.date_from&&t.append("date_from",r.value.date_from),r.value.date_to&&t.append("date_to",r.value.date_to),r.value.sort&&t.append("sort",r.value.sort),r.value.dir&&t.append("dir",r.value.dir);const g=await v(`/affiliate/tickets?${t.toString()}`);if(g.success)d.value=g.data,m.value=g.pagination;else throw new Error(g.message||"Failed to fetch tickets")}catch(t){n.value=t.message||"An error occurred while fetching tickets",console.error("Error fetching affiliate tickets:",t)}finally{o.value.list=!1}},w=async e=>{o.value.detail=!0,n.value=null;try{const a=await v(`/affiliate/tickets/${e}`);if(a.success)c.value=a.data;else throw new Error(a.message||"Failed to fetch ticket")}catch(a){n.value=a.message||"An error occurred while fetching the ticket",console.error("Error fetching affiliate ticket:",a)}finally{o.value.detail=!1}};return{tickets:d,currentTicket:c,loading:o,error:n,pagination:m,filters:r,hasTickets:_,isLoadingList:k,isLoadingDetail:b,isLoadingCreate:L,isLoadingMessage:E,isLoadingStatus:T,fetchTickets:y,fetchTicket:w,createTicket:async e=>{var a;o.value.create=!0,n.value=null;try{const i=new FormData;i.append("subject",e.subject),i.append("category",e.category),i.append("priority",e.priority),i.append("message",e.message),(a=e.attachments)!=null&&a.length&&e.attachments.forEach((l,t)=>{i.append(`attachments[${t}]`,l)});const s=await v("/affiliate/tickets",{method:"POST",body:i});if(s.success)return await y(),h(),s.data;throw new Error(s.message||"Failed to create ticket")}catch(i){throw n.value=i.message||"An error occurred while creating the ticket",console.error("Error creating affiliate ticket:",i),i}finally{o.value.create=!1}},addMessage:async(e,a)=>{var i,s;o.value.message=!0,n.value=null;try{const l=new FormData;l.append("message",a.message),(i=a.attachments)!=null&&i.length&&a.attachments.forEach((g,u)=>{l.append(`attachments[${u}]`,g)});const t=await v(`/affiliate/tickets/${e}/messages`,{method:"POST",body:l});if(t.success)return((s=c.value)==null?void 0:s.id)===e&&await w(e),t.data;throw new Error(t.message||"Failed to add message")}catch(l){throw n.value=l.message||"An error occurred while adding the message",console.error("Error adding message to affiliate ticket:",l),l}finally{o.value.message=!1}},updateTicketStatus:async(e,a)=>{var i;o.value.status=!0,n.value=null;try{const s=await v(`/affiliate/tickets/${e}/status`,{method:"PATCH",body:JSON.stringify({status:a})});if(s.success){if(((i=c.value)==null?void 0:i.id)===e){const t=c.value.messages;c.value={...s.data,messages:t}}const l=d.value.findIndex(t=>t.id===e);return l!==-1&&(d.value[l]={...d.value[l],status:s.data.status,resolved_at:s.data.resolved_at,last_activity_at:s.data.last_activity_at,updated_at:s.data.updated_at}),h(),s.data}else throw new Error(s.message||"Failed to update ticket status")}catch(s){throw n.value=s.message||"An error occurred while updating the ticket status",console.error("Error updating affiliate ticket status:",s),s}finally{o.value.status=!1}},updateFilters:e=>{r.value={...r.value,...e}},resetFilters:()=>{r.value={q:"",status:[],priority:[],category:[],date_from:"",date_to:"",sort:"last_activity_at",dir:"desc",per_page:15}},clearCurrentTicket:()=>{c.value=null},getStatusColor:e=>({open:"info",pending:"warning",waiting_user:"orange",waiting_third_party:"purple",resolved:"success",closed:"secondary"})[e]||"secondary",getStatusLabel:e=>({open:"Ouvert",pending:"En attente",waiting_user:"En attente utilisateur",waiting_third_party:"En attente tiers",resolved:"Résolu",closed:"Fermé"})[e]||e,getPriorityColor:e=>({low:"success",normal:"info",high:"warning",urgent:"error"})[e]||"secondary",getPriorityLabel:e=>({low:"Faible",normal:"Normal",high:"Élevée",urgent:"Urgent"})[e]||e,getCategoryLabel:e=>({general:"Général",orders:"Commandes",payments:"Paiements",commissions:"Commissions",kyc:"KYC",technical:"Technique",other:"Autre"})[e]||e}});export{U as u};
