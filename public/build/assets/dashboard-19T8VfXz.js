import{u as ee}from"./useAuth-Gxh1X3Vv.js";import{b5 as ae,r as b,V as m,ba as T,d as te,aL as re,o as se,bb as le,w as oe,c as G,b as x,e as l,f as A,h as Y,m as ne,v as c,n as s,g as t,az as H,t as f,ac as ie,F as de,j as ce}from"./main-0h7RfoM1.js";import{u as ue}from"./useNotifications-QM5aCJtM.js";import{S as fe,D as me}from"./StatisticsCard-DDrW-ivD.js";import{_ as he}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-pmQ-bLAs.js";import{V as pe}from"./VSelect-E3I5xPtI.js";import{V as be}from"./VAlert-S22fKLZ6.js";import{a as E,V as M}from"./VRow-CwTmyELD.js";import{V as I,a as _e,b as L,d as ge}from"./VCard-BJO62jXa.js";import{V as R}from"./VCardText-DBDe3l6V.js";import{V as $}from"./VDataTable-CrgqCoMT.js";import{V as q}from"./VChip-Cb1gcZbV.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./VAvatar-BcyggOHV.js";import"./VImg-D8VstP0L.js";import"./VBreadcrumbs-C5bXM6fl.js";import"./VTextField-CB8SxAnl.js";import"./VField-ThiSfLeE.js";import"./forwardRefs-DtnMMuBS.js";import"./VList-D8OGLl9W.js";import"./ssrBoot-_8LWlSSM.js";import"./createSimpleFunctional-CRjW3p8V.js";import"./VDivider-CF-VI2ua.js";import"./dialog-transition--QLlkKWU.js";import"./VMenu-BRSAgo5d.js";import"./VOverlay-cV5WKNuZ.js";import"./lazy-DAn2yZiW.js";import"./VCheckboxBtn-DNqYvCTV.js";/* empty css              */import"./VPagination-CjKu94po.js";import"./VTable-BHYHnEIv.js";import"./filter-BbUs5nlv.js";const ye=ae("affiliateDashboard",()=>{const S=b(null),r=b({}),w=b({}),o=b(null),h=b({stats:!1,charts:!1,tables:!1,referralLink:!1}),_=b(null),k=b(null),g=b({dateRange:{start:new Date(Date.now()-720*60*60*1e3).toISOString().split("T")[0],end:new Date().toISOString().split("T")[0]},period:"month",page:1,perPage:15}),C=m(()=>h.value.stats||h.value.charts||h.value.tables),P=m(()=>S.value!==null),O=m(()=>{var e;return((e=S.value)==null?void 0:e.cards)??[]}),D=e=>{const i=O.value.find(d=>d.key===e);return(i==null?void 0:i.value)??0},B=m(()=>D("total_orders")),N=m(()=>D("total_commissions")),V=m(()=>D("monthly_earnings")),z=m(()=>D("payments_status")),F=m(()=>D("pending_tickets")),u=async e=>{h.value.stats=!0,_.value=null;try{const i={...g.value,...e},d=await T("/affiliate/dashboard/stats",{method:"GET",params:i});if(d.success)S.value=d.data,k.value=new Date;else throw new Error(d.message||"Failed to fetch dashboard stats")}catch(i){_.value=i instanceof Error?i.message:"An error occurred",console.error("Error fetching affiliate dashboard stats:",i)}finally{h.value.stats=!1}},n=async(e,i)=>{h.value.charts=!0,_.value=null;try{e?await p(e,i):await p("top_products_sold")}catch(d){_.value=d instanceof Error?d.message:"An error occurred",console.error("Error fetching affiliate dashboard charts:",d)}finally{h.value.charts=!1}},p=async(e,i)=>{const d={...g.value,...i,type:e},v=await T("/affiliate/dashboard/charts",{method:"GET",params:d});if(v.success)r.value[e]=v.data;else throw new Error(v.message||`Failed to fetch ${e} chart data`)},a=async(e,i)=>{h.value.tables=!0,_.value=null;try{const d={...g.value,...i,type:e},v=await T("/affiliate/dashboard/tables",{method:"GET",params:d});if(v.success)w.value[e]=v.data;else throw new Error(v.message||"Failed to fetch table data")}catch(d){_.value=d instanceof Error?d.message:"An error occurred",console.error(`Error fetching affiliate dashboard table data (${e}):`,d)}finally{h.value.tables=!1}},y=async()=>{h.value.referralLink=!0,_.value=null;try{const e=await T("/affiliate/dashboard/referral-link",{method:"GET"});if(e.success)o.value=e.data;else throw new Error(e.message||"Failed to fetch referral link")}catch(e){_.value=e instanceof Error?e.message:"An error occurred",console.error("Error fetching referral link:",e)}finally{h.value.referralLink=!1}},U=e=>{g.value={...g.value,...e}},j=async()=>{await Promise.all([u(),n(),a("my_recent_orders"),a("my_recent_payments"),a("my_active_referrals"),y()])},K=()=>{S.value=null,r.value={},w.value={},o.value=null,_.value=null,k.value=null},W=async()=>{var e;if(!((e=o.value)!=null&&e.link))throw new Error("No referral link available");try{return await navigator.clipboard.writeText(o.value.link),!0}catch(i){throw console.error("Failed to copy referral link:",i),new Error("Failed to copy referral link")}},J=m(()=>{const e=r.value.top_products_sold;if(!e||!e.items||e.items.length===0)return null;const i=e.items.map(v=>v.label),d=e.items.map(v=>v.value);return{labels:i,datasets:[{label:"Top Products",data:d,backgroundColor:["#7367F0","#FF9F43","#28C76F","#EA5455","#00CFE8"],borderWidth:2}]}}),Q=m(()=>{const e=w.value.my_recent_orders;return Array.isArray(e)?e:(e==null?void 0:e.rows)||[]}),X=m(()=>{const e=w.value.my_recent_payments;return Array.isArray(e)?e:(e==null?void 0:e.rows)||[]}),Z=m(()=>{const e=w.value.my_active_referrals;return Array.isArray(e)?e:(e==null?void 0:e.rows)||[]});return{stats:S,chartData:r,tableData:w,referralLink:o,loading:h,error:_,lastUpdated:k,filters:g,isLoading:C,hasData:P,totalOrders:B,totalCommissions:N,monthlyEarnings:V,paymentsStatus:z,pendingTickets:F,topProductsSoldChart:J,myRecentOrders:Q,myRecentPayments:X,myActiveReferrals:Z,fetchStats:u,fetchChartData:n,fetchTableData:a,fetchReferralLink:y,updateFilters:U,refreshAll:j,clearData:K,copyReferralLink:W}}),we={class:"affiliate-dashboard"},ke={class:"d-flex align-center justify-space-between mb-6"},De={class:"text-h4 font-weight-bold mb-1"},Se={class:"text-body-1 text-medium-emphasis"},Ce={class:"d-flex align-center gap-3"},Ve=te({__name:"dashboard",setup(S){const{t:r}=re(),{user:w}=ee(),o=ye(),{showSuccess:h,showError:_}=ue(),k=b("month"),g=b(null),C=b(!0);b(!1),b([new Date(Date.now()-720*60*60*1e3).toISOString().split("T")[0],new Date().toISOString().split("T")[0]]);const P=m(()=>[{title:r("affiliate"),disabled:!1,href:"/affiliate"},{title:r("dashboard"),disabled:!0,href:"/affiliate/dashboard"}]),O=m(()=>{var u;return(u=o.stats)!=null&&u.cards?o.stats.cards.map(n=>{let p=n.value,a;return["total_commissions","monthly_earnings","received_payments","pending_payments"].includes(n.key)&&(a="DH"),{title:r(n.labelKey),value:p,icon:D(n.key),color:B(n.key),prefix:a}}):[]}),D=u=>({total_orders:"tabler-shopping-cart",total_commissions:"tabler-currency-dollar",monthly_earnings:"tabler-calendar",received_payments:"tabler-check-circle",pending_payments:"tabler-clock",pending_tickets:"tabler-ticket"})[u]||"tabler-chart-bar",B=u=>({total_orders:"primary",total_commissions:"success",monthly_earnings:"info",received_payments:"success",pending_payments:"warning",pending_tickets:"error"})[u]||"primary";m(()=>[{id:"top_products_sold",title:r("dashboard.affiliate.charts.top_products_sold"),type:"doughnut",data:o.topProductsSoldChart,cols:{cols:12},description:r("dashboard.affiliate.charts.top_products_sold.description")}]);const N=[{value:"month",label:r("dashboard.filters.period.month"),icon:"tabler-calendar-month"},{value:"quarter",label:r("dashboard.filters.period.quarter"),icon:"tabler-calendar-stats"},{value:"year",label:r("dashboard.filters.period.year"),icon:"tabler-calendar-year"}],V=async()=>{try{await o.refreshAll(),C.value&&h(r("affiliate_dashboard_refresh_success"))}catch{_(r("errors.dashboard_refresh_failed"))}},z=async u=>{console.log("Affiliate Dashboard - Period changed to:",u),k.value=u;const n=new Date;let p;switch(u){case"month":p=new Date(n.getFullYear(),n.getMonth(),1);break;case"quarter":const y=Math.floor(n.getMonth()/3);p=new Date(n.getFullYear(),y*3,1);break;case"year":p=new Date(n.getFullYear(),0,1);break;default:p=new Date(n.getFullYear(),n.getMonth(),1)}const a={start:p.toISOString().split("T")[0],end:n.toISOString().split("T")[0]};console.log("Affiliate Dashboard - Date range:",a),o.updateFilters({dateRange:a,period:u}),console.log("Affiliate Dashboard - Refreshing data..."),await Promise.all([o.fetchStats(),o.fetchChartData("top_products_sold"),o.fetchTableData("my_recent_orders"),o.fetchTableData("my_recent_payments"),o.fetchTableData("my_active_referrals")]),console.log("Affiliate Dashboard - Chart data after refresh:",o.topProductsSoldChart)},F=()=>{g.value&&clearInterval(g.value),C.value&&(g.value=setInterval(()=>{V()},300*1e3))};return se(async()=>{console.log("Dashboard mounted with period:",k.value),await V(),F()}),le(()=>{g.value&&clearInterval(g.value)}),oe(C,F),(u,n)=>{var p;return x(),G("div",we,[l(he,{items:P.value},null,8,["items"]),A("div",ke,[A("div",null,[A("h1",De,c(s(r)("dashboard.affiliate.title")),1),A("p",Se,c(s(r)("dashboard.affiliate.welcome",{name:(p=s(w))==null?void 0:p.nom_complet})),1)]),A("div",Ce,[l(pe,{modelValue:k.value,"onUpdate:modelValue":[n[0]||(n[0]=a=>k.value=a),z],items:N,"item-title":"label","item-value":"value",label:s(r)("dashboard.filters.period.label"),variant:"outlined",density:"compact",style:{"min-width":"150px"}},{"prepend-inner":t(()=>[l(H,{icon:"tabler-calendar",size:"16"})]),_:1},8,["modelValue","label"]),l(ie,{color:"primary",variant:"outlined",loading:s(o).isLoading,onClick:V},{default:t(()=>[l(H,{start:"",icon:"tabler-refresh"}),f(" "+c(s(r)("dashboard.common.refresh")),1)]),_:1},8,["loading"])])]),s(o).error?(x(),Y(be,{key:0,type:"error",variant:"tonal",class:"mb-6",closable:"","onClick:close":n[1]||(n[1]=a=>s(o).error=null)},{default:t(()=>[f(c(s(o).error),1)]),_:1})):ne("",!0),l(M,{class:"mb-6"},{default:t(()=>[(x(!0),G(de,null,ce(O.value,a=>(x(),Y(E,{key:a.title,cols:"12",sm:"6",md:"4",lg:"4"},{default:t(()=>[l(fe,{title:a.title,value:a.value,icon:a.icon,color:a.color,prefix:a.prefix,loading:s(o).loading.stats},null,8,["title","value","icon","color","prefix","loading"])]),_:2},1024))),128))]),_:1}),l(M,{class:"mb-6"},{default:t(()=>[l(E,{cols:"6"},{default:t(()=>[l(I,null,{default:t(()=>[l(_e,null,{default:t(()=>[l(L,null,{default:t(()=>[f(c(s(r)("dashboard.affiliate.charts.top_products_sold")),1)]),_:1}),l(ge,null,{default:t(()=>[f(c(s(r)("dashboard.affiliate.charts.top_products_sold.description")),1)]),_:1})]),_:1}),l(R,null,{default:t(()=>[l(me,{type:"doughnut",data:s(o).topProductsSoldChart,loading:s(o).loading.charts,error:s(o).error},null,8,["data","loading","error"])]),_:1})]),_:1})]),_:1}),l(E,{cols:"12",md:"6"},{default:t(()=>[l(I,null,{default:t(()=>[l(L,null,{default:t(()=>[f(c(s(r)("dashboard.affiliate.tables.my_recent_orders")),1)]),_:1}),l(R,null,{default:t(()=>[l($,{items:s(o).myRecentOrders,headers:[{title:s(r)("dashboard.affiliate.tables.columns.product"),key:"product"},{title:s(r)("dashboard.affiliate.tables.columns.amount"),key:"amount"},{title:s(r)("dashboard.affiliate.tables.columns.status"),key:"status"},{title:s(r)("dashboard.affiliate.tables.columns.date"),key:"date"}],loading:s(o).loading.tables,density:"compact","hide-default-footer":"","items-per-page":"5"},{"item.amount":t(({item:a})=>{var y;return[f(c((y=a.amount)==null?void 0:y.toLocaleString())+" DH ",1)]}),"item.date":t(({item:a})=>[f(c(new Date(a.date).toLocaleDateString()),1)]),"item.status":t(({item:a})=>[l(q,{color:a.status==="delivered"?"success":a.status==="pending"?"warning":"error",size:"small",variant:"tonal"},{default:t(()=>[f(c(a.status),1)]),_:2},1032,["color"])]),_:1},8,["items","headers","loading"])]),_:1})]),_:1})]),_:1})]),_:1}),l(M,null,{default:t(()=>[l(E,{cols:"12",md:"6"},{default:t(()=>[l(I,null,{default:t(()=>[l(L,null,{default:t(()=>[f(c(s(r)("dashboard.affiliate.tables.my_recent_payments")),1)]),_:1}),l(R,null,{default:t(()=>[l($,{items:s(o).myRecentPayments,headers:[{title:s(r)("dashboard.affiliate.tables.columns.amount"),key:"amount"},{title:s(r)("dashboard.affiliate.tables.columns.status"),key:"status"},{title:s(r)("dashboard.affiliate.tables.columns.date"),key:"date"}],loading:s(o).loading.tables,density:"compact","hide-default-footer":"","items-per-page":"5"},{"item.amount":t(({item:a})=>{var y;return[f(c((y=a.amount)==null?void 0:y.toLocaleString())+" DH ",1)]}),"item.date":t(({item:a})=>[f(c(new Date(a.date).toLocaleDateString()),1)]),"item.status":t(({item:a})=>[l(q,{color:a.status==="paid"?"success":a.status==="pending"?"warning":"error",size:"small",variant:"tonal"},{default:t(()=>[f(c(a.status),1)]),_:2},1032,["color"])]),_:1},8,["items","headers","loading"])]),_:1})]),_:1})]),_:1}),l(E,{cols:"12",md:"6"},{default:t(()=>[l(I,null,{default:t(()=>[l(L,null,{default:t(()=>[f(c(s(r)("dashboard.affiliate.tables.my_active_referrals")),1)]),_:1}),l(R,null,{default:t(()=>[l($,{items:s(o).myActiveReferrals,headers:[{title:s(r)("dashboard.affiliate.tables.columns.name"),key:"name"},{title:s(r)("dashboard.affiliate.tables.columns.email"),key:"email"},{title:s(r)("dashboard.affiliate.tables.columns.signup_date"),key:"signup_date"},{title:s(r)("dashboard.affiliate.tables.columns.status"),key:"status"}],loading:s(o).loading.tables,density:"compact","hide-default-footer":"","items-per-page":"5"},{"item.signup_date":t(({item:a})=>[f(c(new Date(a.signup_date).toLocaleDateString()),1)]),"item.status":t(({item:a})=>[l(q,{color:a.status==="verified"?"success":"pending",size:"small",variant:"tonal"},{default:t(()=>[f(c(a.status),1)]),_:2},1032,["color"])]),_:1},8,["items","headers","loading"])]),_:1})]),_:1})]),_:1})]),_:1})])}}}),la=ve(Ve,[["__scopeId","data-v-dc463739"]]);export{la as default};
