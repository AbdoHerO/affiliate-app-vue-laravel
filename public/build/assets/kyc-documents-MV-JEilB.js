import{d as we,aL as Ve,r as y,V as ke,o as Ue,c as U,b as k,f as i,e as a,v as r,n as o,g as s,t as m,az as x,ac as w,aP as xe,h as H,m as O,F as De,j as Ce,aU as $e,aW as W}from"./main-BW7J9dbc.js";import{u as Se}from"./useAuth-CSUeXPIW.js";import{u as X,n as je}from"./useApi-C5OI9_Dc.js";import{u as Fe}from"./useNotifications-C-RqLAHj.js";import{useQuickConfirm as Te}from"./useConfirmAction-C1AhwA5O.js";import{c as Ae,S as Pe}from"./SoftDeleteActions-D-IvYhGv.js";import{S as ze}from"./SoftDeleteFilter-B-xMAU3a.js";import{V as E}from"./VCardText-CXwuP4rm.js";import{V as Le,a as C}from"./VRow-CGHQgNV4.js";import{V as Re}from"./VTextField-DCEu5f_P.js";import{V as $}from"./VSelect-BbnjVQGu.js";import{V as N,b as Z,c as ee}from"./VCard-BBEboEsQ.js";import{V as Ee}from"./VTable-CglbVig3.js";import{V as q}from"./VChip-Dc9HlRo1.js";import{V as M}from"./VTooltip-DmGX3M8u.js";import{V as te}from"./VForm-CCkDJA8t.js";import{a as Ne,b as Ie}from"./VList-BrmO1UK3.js";import{V as Be}from"./VFileInput-Dsp3Fy5B.js";import{V as le}from"./VSpacer-BxZvfEPo.js";import{V as ae}from"./VDialog-BYRvlSU6.js";import{V as Oe}from"./VTextarea-Wxm7h69M.js";import{V as qe}from"./VSnackbar-Ceqlfmxs.js";import"./ActionIcon-lhNXk9f5.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";/* empty css              */import"./VField-ECDxRtcR.js";import"./VImg-NyJdDnCF.js";import"./forwardRefs-t39oHzh6.js";import"./dialog-transition-C3MiiA6M.js";import"./VMenu-DTZ6uDZD.js";import"./VOverlay-CpnKYLAB.js";import"./lazy-CTr8uHza.js";import"./VCheckboxBtn-BRmrHq-R.js";import"./VAvatar-CBx3oh99.js";import"./createSimpleFunctional-468wPgla.js";import"./ssrBoot-DTcmQToe.js";import"./VDivider-C4kHsR9g.js";const Me={class:"d-flex justify-space-between align-center mb-6"},Ke={class:"text-h4 font-weight-bold mb-1"},Ye={class:"text-body-1 text-medium-emphasis"},Qe={class:"font-weight-medium"},Ge={class:"text-caption text-medium-emphasis"},Je={key:0,class:"text-caption text-error mt-1"},He={class:"d-flex gap-2"},We={key:1,class:"text-center py-8"},Xe={class:"mt-4"},Ze={key:2,class:"text-center py-8"},et={class:"text-h6 mb-2"},tt={class:"text-body-2 text-medium-emphasis"},lt={key:3,class:"text-center py-8"},at={class:"text-h6 mb-2"},ot={class:"text-body-2 text-medium-emphasis"},st={class:"text-caption text-medium-emphasis"},rt={class:"mb-4"},nt={class:"text-h6 mb-2"},Qt=we({__name:"kyc-documents",setup(ut){const{t:l}=Ve();Se();const{showSuccess:K,showError:v,snackbar:S}=Fe(),{confirmUpdate:oe,confirmDelete:it}=Te(),{filter:I,getQueryParams:se,getStatusColor:re,getStatusText:ne}=Ae({entityName:"document",apiEndpoint:"/admin/kyc-documents",onSuccess:()=>f(),onError:n=>console.error("Soft delete error:",n)}),h=y(!1),j=y(null),F=y([]),b=y(null),D=y([]),z=y(!1),T=y(!1),A=y(!1),Y=y({current_page:1,last_page:1,per_page:15,total:0}),c=y({search:"",type_doc:"",statut:"",user_id:""}),p=y({utilisateur_id:"",type_doc:"cni",fichier:null}),V=y({statut:"en_attente",motif_refus:""}),Q=[{title:l("all_types"),value:""},{title:l("document_cni"),value:"cni"},{title:l("document_passport"),value:"passport"},{title:l("document_rib"),value:"rib"},{title:l("document_contract"),value:"contrat"}],ue=[{title:l("all_status"),value:""},{title:l("pending"),value:"en_attente"},{title:l("approved"),value:"valide"},{title:l("rejected"),value:"refuse"}],ie=[{title:l("pending"),value:"en_attente"},{title:l("approved"),value:"valide"},{title:l("rejected"),value:"refuse"}],de=ke(()=>F.value.filter(n=>{const e=!c.value.search||n.utilisateur.nom_complet.toLowerCase().includes(c.value.search.toLowerCase())||n.utilisateur.email.toLowerCase().includes(c.value.search.toLowerCase()),t=!c.value.type_doc||n.type_doc===c.value.type_doc,u=!c.value.statut||n.statut===c.value.statut;return e&&t&&u})),ce=async()=>{try{z.value=!0,console.log("🔍 Fetching users...");const e="https://tujjar.shop/api/admin/users?per_page=1000";console.log("🔍 Fetching users from:",e);const t=await fetch(e,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,Accept:"application/json","Content-Type":"application/json"}});if(console.log("🔍 Users API response status:",t.status),!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const u=await t.json();console.log("🔍 Users API response data:",u);let d=[];if(u.users&&Array.isArray(u.users))d=u.users,console.log("✅ Found users in responseData.users:",d.length);else if(u.data&&Array.isArray(u.data))d=u.data,console.log("✅ Found users in responseData.data:",d.length);else if(Array.isArray(u))d=u,console.log("✅ Found users in responseData array:",d.length);else{console.error("❌ Unexpected users data format:",u),console.error("❌ Expected: { users: [...] } or { data: [...] } or [...]"),v(l("admin_kyc_unexpected_users_format"));return}if(console.log("🔍 Processing users data:",d),d.length===0){console.log("⚠️ No users found in response"),D.value=[];return}D.value=d.map(_=>{const g={title:`${_.nom_complet} (${_.email}) - ${_.kyc_statut}`,value:_.id};return console.log("🔍 Created user option:",g),g}),console.log("✅ Users loaded successfully:",D.value.length,D.value)}catch(n){console.error("❌ Users fetch error:",n),v("Failed to load users: "+n.message)}finally{z.value=!1}},f=async(n=1)=>{try{h.value=!0,j.value=null;const e=new URLSearchParams({page:n.toString(),per_page:Y.value.per_page.toString(),...se()});c.value.search&&e.set("search",c.value.search),c.value.type_doc&&e.set("type_doc",c.value.type_doc),c.value.statut&&e.set("statut",c.value.statut);const t=`/admin/kyc-documents?${e.toString()}`,{data:u,error:d}=await X(t);d.value?(j.value=d.value.message,v(d.value.message),console.error("KYC documents fetch error:",d.value)):u.value&&(F.value=u.value.data||[],Y.value={current_page:u.value.current_page||1,last_page:u.value.last_page||1,per_page:u.value.per_page||15,total:u.value.total||0},console.log("✅ KYC documents loaded successfully:",F.value.length))}catch(e){console.error("KYC documents fetch error:",e);const t=e.message||"Failed to load KYC documents";j.value=t,v(t)}finally{h.value=!1}},G=async()=>{var n;if(!p.value.fichier){v("Please select a file");return}if(!p.value.utilisateur_id){v("Please select a user");return}if(!p.value.type_doc){v("Please select a document type");return}try{h.value=!0,console.log("🔍 Upload form data:",{utilisateur_id:p.value.utilisateur_id,type_doc:p.value.type_doc,fichier:(n=p.value.fichier)==null?void 0:n.name});const e=new FormData;e.append("utilisateur_id",p.value.utilisateur_id),e.append("type_doc",p.value.type_doc),e.append("fichier",p.value.fichier),console.log("🔍 FormData contents:");for(const[g,L]of e.entries())console.log(`  ${g}:`,L);const u="https://tujjar.shop/api/admin/kyc-documents";console.log("🔍 Upload URL:",u);const d=await fetch(u,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,Accept:"application/json"},body:e});if(console.log("🔍 Upload response status:",d.status),!d.ok){const g=await je(d);console.error("❌ Upload error response:",g),v(g.message);return}const _=await d.json();console.log("✅ Upload success response:",_),T.value=!1,ge(),await f(),K(l("document_uploaded_successfully"))}catch(e){console.error("❌ Upload document error:",e),v(e.message||l("failed_to_upload_document"))}finally{h.value=!1}},me=n=>{b.value=n,V.value={statut:n.statut,motif_refus:n.motif_refus||""},A.value=!0},J=async()=>{if(!(!b.value||!await oe(l("document"),`${B(b.value.type_doc)} - ${b.value.utilisateur.nom_complet}`)))try{h.value=!0;const{data:e,error:t}=await X(`/admin/kyc-documents/${b.value.id}`,{method:"PUT",body:JSON.stringify({statut:V.value.statut,motif_refus:V.value.motif_refus}),headers:{"Content-Type":"application/json"}});t.value?(v(t.value.message),console.error("Review document error:",t.value)):e.value&&(A.value=!1,ye(),await f(),K(l("document_reviewed_successfully")))}catch(e){v(e.message||l("failed_to_review_document")),console.error("Review document error:",e)}finally{h.value=!1}},pe=async n=>{try{console.log("🔍 Downloading document:",n.id);const t=`https://tujjar.shop/api/admin/kyc-documents/${n.id}/download`;console.log("🔍 Download URL:",t);const u=await fetch(t,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(console.log("🔍 Download response status:",u.status),console.log("🔍 Download response headers:",Object.fromEntries(u.headers.entries())),u.ok){const d=await u.blob();console.log("🔍 Downloaded blob:",{size:d.size,type:d.type});const _=u.headers.get("Content-Disposition");let g=`kyc-${n.type_doc}-${n.utilisateur.nom_complet}`;if(_){const R=_.match(/filename="([^"]+)"/);R&&(g=R[1])}else{const R=fe(n.url_fichier)||ve(d.type);g+=`.${R}`}console.log("🔍 Download filename:",g);const L=window.URL.createObjectURL(d),P=document.createElement("a");P.href=L,P.download=g,document.body.appendChild(P),P.click(),window.URL.revokeObjectURL(L),document.body.removeChild(P),console.log("✅ Download completed successfully")}else{const d=await u.text();console.error("❌ Download failed:",u.status,d),v(l("admin_kyc_download_failed"))}}catch(e){console.error("❌ Download error:",e),v(l("admin_kyc_download_failed"))}},fe=n=>{const e=n.match(/\.([^.]+)$/);return e?e[1]:null},ve=n=>{switch(n){case"application/pdf":return"pdf";case"image/jpeg":return"jpg";case"image/png":return"png";default:return"bin"}},_e=n=>{const t=`https://tujjar.shop/api/admin/kyc-documents/${n.id}/file`;console.log("🔍 Opening view URL:",t),window.open(t,"_blank")},ge=()=>{p.value={utilisateur_id:"",type_doc:"cni",fichier:null}},ye=()=>{V.value={statut:"en_attente",motif_refus:""},b.value=null},he=n=>{const e=n.target;e.files&&e.files[0]?(p.value.fichier=e.files[0],console.log("🔍 File selected:",{name:e.files[0].name,size:e.files[0].size,type:e.files[0].type})):console.log("❌ No file selected")},be=n=>{switch(n){case"valide":return"success";case"refuse":return"error";case"en_attente":return"warning";default:return"default"}},B=n=>{switch(n){case"cni":return l("admin_kyc_type_cni");case"passport":return l("admin_kyc_type_passport");case"rib":return l("admin_kyc_type_rib");case"contrat":return l("admin_kyc_type_contract");default:return n}};return Ue(async()=>{await f(),await ce()}),(n,e)=>(k(),U("div",null,[i("div",Me,[i("div",null,[i("h1",Ke,r(o(l)("kyc_documents")),1),i("p",Ye,r(o(l)("manage_kyc_documents_desc")),1)]),a(w,{color:"primary",onClick:e[0]||(e[0]=t=>T.value=!0)},{default:s(()=>[a(x,{start:"",icon:"tabler-upload"}),m(" "+r(o(l)("upload_document")),1)]),_:1})]),a(N,{class:"mb-6"},{default:s(()=>[a(E,null,{default:s(()=>[a(Le,null,{default:s(()=>[a(C,{cols:"12",md:"2"},{default:s(()=>[a(Re,{modelValue:c.value.search,"onUpdate:modelValue":e[1]||(e[1]=t=>c.value.search=t),label:o(l)("search"),placeholder:o(l)("search_users"),"prepend-inner-icon":"tabler-search",clearable:"",onInput:e[2]||(e[2]=t=>f(1))},null,8,["modelValue","label","placeholder"])]),_:1}),a(C,{cols:"12",md:"2"},{default:s(()=>[a($,{modelValue:c.value.type_doc,"onUpdate:modelValue":[e[3]||(e[3]=t=>c.value.type_doc=t),e[4]||(e[4]=t=>f(1))],items:Q,label:o(l)("document_type"),clearable:""},null,8,["modelValue","label"])]),_:1}),a(C,{cols:"12",md:"2"},{default:s(()=>[a($,{modelValue:c.value.statut,"onUpdate:modelValue":[e[5]||(e[5]=t=>c.value.statut=t),e[6]||(e[6]=t=>f(1))],items:ue,label:o(l)("status"),clearable:""},null,8,["modelValue","label"])]),_:1}),a(C,{cols:"12",md:"2"},{default:s(()=>[a(ze,{modelValue:o(I),"onUpdate:modelValue":[e[7]||(e[7]=t=>xe(I)?I.value=t:null),e[8]||(e[8]=t=>f(1))]},null,8,["modelValue"])]),_:1}),a(C,{cols:"12",md:"2"},{default:s(()=>[a($,{modelValue:c.value.user_id,"onUpdate:modelValue":[e[9]||(e[9]=t=>c.value.user_id=t),e[10]||(e[10]=t=>f(1))],items:D.value,label:o(l)("filter_by_user"),loading:z.value,clearable:""},null,8,["modelValue","items","label","loading"])]),_:1}),a(C,{cols:"12",md:"2",class:"d-flex align-center"},{default:s(()=>[a(w,{variant:"outlined",onClick:e[11]||(e[11]=t=>f(1)),loading:h.value},{default:s(()=>[a(x,{start:"",icon:"tabler-refresh"}),m(" "+r(o(l)("refresh")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1}),a(N,null,{default:s(()=>[a(E,null,{default:s(()=>[!h.value&&F.value.length?(k(),H(Ee,{key:0},{default:s(()=>[i("thead",null,[i("tr",null,[i("th",null,r(o(l)("user")),1),i("th",null,r(o(l)("document_type")),1),i("th",null,r(o(l)("status")),1),i("th",null,r(o(l)("record_status")),1),i("th",null,r(o(l)("uploaded")),1),i("th",null,r(o(l)("actions")),1)])]),i("tbody",null,[(k(!0),U(De,null,Ce(de.value,t=>{var u,d;return k(),U("tr",{key:t.id},[i("td",null,[i("div",null,[i("div",Qe,r(((u=t.utilisateur)==null?void 0:u.nom_complet)||"N/A"),1),i("div",Ge,r(((d=t.utilisateur)==null?void 0:d.email)||"N/A"),1)])]),i("td",null,[a(q,{size:"small",variant:"tonal"},{default:s(()=>[m(r(B(t.type_doc)),1)]),_:2},1024)]),i("td",null,[a(q,{color:be(t.statut),size:"small"},{default:s(()=>[m(r(t.statut),1)]),_:2},1032,["color"]),t.motif_refus?(k(),U("div",Je,r(t.motif_refus),1)):O("",!0)]),i("td",null,[a(q,{color:o(re)(t),size:"small",variant:"elevated"},{default:s(()=>[m(r(o(ne)(t)),1)]),_:2},1032,["color"])]),i("td",null,r(new Date(t.created_at).toLocaleDateString()),1),i("td",null,[i("div",He,[a(w,{icon:"",size:"small",color:"success",variant:"text",onClick:_=>_e(t)},{default:s(()=>[a(x,{icon:"tabler-eye"}),a(M,{activator:"parent"},{default:s(()=>[m(r(o(l)("view")),1)]),_:1})]),_:2},1032,["onClick"]),a(w,{icon:"",size:"small",color:"primary",variant:"text",onClick:_=>pe(t)},{default:s(()=>[a(x,{icon:"tabler-download"}),a(M,{activator:"parent"},{default:s(()=>[m(r(o(l)("download")),1)]),_:1})]),_:2},1032,["onClick"]),a(w,{icon:"",size:"small",color:"info",variant:"text",onClick:_=>me(t)},{default:s(()=>[a(x,{icon:"tabler-edit"}),a(M,{activator:"parent"},{default:s(()=>[m(r(o(l)("review")),1)]),_:1})]),_:2},1032,["onClick"]),a(Pe,{item:t,"entity-name":"document","api-endpoint":"/admin/kyc-documents","item-name-field":"type_doc","show-edit":!1,"show-view":!1,onDeleted:f,onRestored:f,onPermanentlyDeleted:f},null,8,["item"])])])])}),128))])]),_:1})):h.value?(k(),U("div",We,[a($e,{indeterminate:"",color:"primary"}),i("p",Xe,r(o(l)("loading"))+"...",1)])):F.value.length?j.value?(k(),U("div",lt,[a(x,{icon:"tabler-alert-circle",size:"64",class:"text-error mb-4"}),i("h3",at,r(o(l)("error_loading_documents")),1),i("p",ot,r(j.value),1),a(w,{color:"primary",variant:"outlined",onClick:e[12]||(e[12]=t=>f()),class:"mt-4"},{default:s(()=>[m(r(o(l)("try_again")),1)]),_:1})])):O("",!0):(k(),U("div",Ze,[a(x,{icon:"tabler-file-x",size:"64",class:"text-disabled mb-4"}),i("h3",et,r(o(l)("no_documents_found")),1),i("p",tt,r(o(l)("no_documents_desc")),1)]))]),_:1})]),_:1}),a(ae,{modelValue:T.value,"onUpdate:modelValue":e[16]||(e[16]=t=>T.value=t),"max-width":"600"},{default:s(()=>[a(N,null,{default:s(()=>[a(Z,null,{default:s(()=>[m(r(o(l)("upload_kyc_document")),1)]),_:1}),a(E,null,{default:s(()=>[a(te,{onSubmit:W(G,["prevent"])},{default:s(()=>[a($,{modelValue:p.value.utilisateur_id,"onUpdate:modelValue":e[13]||(e[13]=t=>p.value.utilisateur_id=t),items:D.value,label:o(l)("select_user"),placeholder:o(l)("choose_user"),loading:z.value,required:"",clearable:"",class:"mb-4"},{"no-data":s(()=>[a(Ne,null,{default:s(()=>[a(Ie,null,{default:s(()=>[m(r(o(l)("no_users_found")),1)]),_:1})]),_:1})]),_:1},8,["modelValue","items","label","placeholder","loading"]),a($,{modelValue:p.value.type_doc,"onUpdate:modelValue":e[14]||(e[14]=t=>p.value.type_doc=t),items:Q.slice(1),label:o(l)("document_type"),required:"",class:"mb-4"},null,8,["modelValue","items","label"]),a(Be,{label:o(l)("select_file"),accept:".pdf,.jpg,.jpeg,.png",onChange:he,required:"",class:"mb-4"},null,8,["label"]),i("p",st,r(o(l)("supported_formats"))+": PDF, JPG, PNG ("+r(o(l)("max_size"))+": 5MB) ",1)]),_:1})]),_:1}),a(ee,null,{default:s(()=>[a(le),a(w,{variant:"outlined",onClick:e[15]||(e[15]=t=>T.value=!1)},{default:s(()=>[m(r(o(l)("cancel")),1)]),_:1}),a(w,{color:"primary",onClick:G,loading:h.value},{default:s(()=>[m(r(o(l)("upload")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ae,{modelValue:A.value,"onUpdate:modelValue":e[20]||(e[20]=t=>A.value=t),"max-width":"600"},{default:s(()=>[a(N,null,{default:s(()=>[a(Z,null,{default:s(()=>[m(r(o(l)("review_document")),1)]),_:1}),b.value?(k(),H(E,{key:0},{default:s(()=>{var t;return[i("div",rt,[i("h4",nt,r(o(l)("document_info")),1),i("p",null,[i("strong",null,r(o(l)("user"))+":",1),m(" "+r(((t=b.value.utilisateur)==null?void 0:t.nom_complet)||"N/A"),1)]),i("p",null,[i("strong",null,r(o(l)("type"))+":",1),m(" "+r(B(b.value.type_doc)),1)]),i("p",null,[i("strong",null,r(o(l)("current_status"))+":",1),m(" "+r(b.value.statut),1)])]),a(te,{onSubmit:W(J,["prevent"])},{default:s(()=>[a($,{modelValue:V.value.statut,"onUpdate:modelValue":e[17]||(e[17]=u=>V.value.statut=u),items:ie,label:o(l)("new_status"),required:"",class:"mb-4"},null,8,["modelValue","label"]),a(Oe,{modelValue:V.value.motif_refus,"onUpdate:modelValue":e[18]||(e[18]=u=>V.value.motif_refus=u),label:o(l)("rejection_reason"),placeholder:o(l)("enter_rejection_reason"),required:V.value.statut==="refuse",rows:"3",class:"mb-4"},null,8,["modelValue","label","placeholder","required"])]),_:1})]}),_:1})):O("",!0),a(ee,null,{default:s(()=>[a(le),a(w,{variant:"outlined",type:"button",onClick:e[19]||(e[19]=t=>A.value=!1)},{default:s(()=>[m(r(o(l)("cancel")),1)]),_:1}),a(w,{color:"primary",type:"button",loading:h.value,onClick:J},{default:s(()=>[m(r(o(l)("save")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(qe,{modelValue:o(S).show,"onUpdate:modelValue":e[21]||(e[21]=t=>o(S).show=t),color:o(S).color,timeout:o(S).timeout,location:"top end"},{default:s(()=>[m(r(o(S).message),1)]),_:1},8,["modelValue","color","timeout"])]))}});export{Qt as default};
